(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerpolicy&&(n.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?n.credentials="include":i.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class S{_canvasDOM;_canvasCtx;static _instance=null;_proj_matrix;_view_matrix;constructor(t){S._instance=this;let e=document.querySelector(t);if(e==null)throw new Error("Invalid name");this._canvasDOM=e;let s=this._canvasDOM.getContext("webgl2",{antialias:!1});if(s==null)throw new Error("Problem with create Context");let i=s.getContextAttributes();i!=null&&(i.antialias=!1),this._canvasCtx=s,this._canvasCtx.clearColor(0,0,0,1),this._canvasCtx.clear(this._canvasCtx.COLOR_BUFFER_BIT),this._proj_matrix=this.get_projection(40,this._canvasDOM.width/this._canvasDOM.height,1,100),this._view_matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._view_matrix[14]=this._view_matrix[14]-6}static get instance(){return this._instance}get_projection(t,e,s,i){var n=Math.tan(t*.5*Math.PI/180);return[.5/n,0,0,0,0,.5*e/n,0,0,0,0,-(i+s)/(i-s),-1,0,0,-2*i*s/(i-s),0]}get canvasDOM(){return this._canvasDOM}get canvasCtx(){return this._canvasCtx}get proj_matrix(){return this._proj_matrix}get view_matrix(){return this._view_matrix}getAspect(){return this._canvasDOM.width/this._canvasDOM.height}}class x{values;rows;cols;constructor(t){t.length==0?(this.values=[[0]],this.cols=1,this.rows=1):t[0]instanceof Object?(this.values=t,this.rows=t.length,this.cols=t[0].length):(this.values=[t],this.rows=1,this.cols=t.length)}get(t,e){if(e<0||e>this.cols||t<0||t>this.rows)throw new Error(`Out of Matrix[${this.cols},${this.rows}]. You cannot get ${e},${t}`);return this.values[t][e]}transpose(){let t=[];return this.values.forEach((e,s)=>e.forEach((i,n)=>{t[n]==null&&(t[n]=[]),t[n][s]=i})),new x(t)}mul(t){let e=[];if(t instanceof x){if(this.cols!=t.rows)throw new Error("You can multiple matrix which first matrix columns is equal second matrix rows");for(let s=0;s<this.rows;s++)for(let i=0;i<t.cols;i++){e[s]==null&&(e[s]=[]),e[s][i]=0;for(let n=0;n<t.rows;n++)e[s][i]+=this.values[s][n]*t.values[n][i]}}else e=this.values.map(s=>s.map(i=>i*t));return new x(e)}cut(t,e){let s=[],i=0;for(let n=0;n<this.rows;n++)for(let a=0;a<this.cols;a++){if(a==e||n==t)continue;let o=Math.floor(i/(this.cols-1)),u=i%(this.cols-1);s[o]==null&&(s[o]=[]),s[o][u]=this.values[n][a],i++}return new x(s)}minor(){if(this.rows==0&&this.cols==0)return new x([[this.values[1][1],this.values[1][0]],[this.values[0][1],this.values[0][0]]]);let t=[];for(let e=0;e<this.rows;e++)for(let s=0;s<this.cols;s++){t[e]==null&&(t[e]=[]);let i=this.cut(e,s).determinant();if(i==null)throw new Error("I cannot calculate minor");t[e][s]=i}return new x(t)}cofactor(){let t=this.minor();for(let e=0;e<t.rows;e++)for(let s=0;s<t.cols;s++)t.values[e][s]*=(s+e)%2==0?1:-1;return t}adjugate(){return this.cofactor().transpose()}determinant(){if(this.rows==2&&this.cols==2)return this.determinant2x2();if(this.rows==this.cols){let t=this.cofactor(),e=0;for(let s=0;s<this.cols;s++)e+=this.values[0][s]*t.get(s,0);return e}return null}determinant2x2(){return this.values[0][0]*this.values[1][1]-this.values[0][1]*this.values[1][0]}inverse(){if(this.rows!=this.cols)throw new Error("Inverse Matrix can be only from square matrix");let t=this.determinant();return t==0||t==null?null:this.adjugate().mul(1/t)}static makeIdentity(t){let e=[];for(let s=0;s<t;s++)for(let i=0;i<t;i++)e[s]==null&&(e[s]=[]),e[s][i]=i==s?1:0;return new x(e)}toVector3(){return new h([this.get(0,0),this.get(1,0),this.get(2,0)])}}class J extends x{constructor(t){super(t)}static get identity(){return this.makeIdentity(3)}static get zero(){return new J([[0,0,0],[0,0,0],[0,0,0]])}static setFromEuler(t){const e=Math.sin,s=Math.cos;let i=new x([[1,0,0],[0,s(t.x),-e(t.x)],[0,e(t.x),s(t.x)]]),n=new x([[s(t.y),0,e(t.y)],[0,1,0],[e(t.y),0,s(t.y)]]),a=new x([[s(t.z),-e(t.z),0],[e(t.z),s(t.z),0],[0,0,1]]);return i.mul(n).mul(a)}}class w{_x;_y;constructor(t){t instanceof Array?(this._x=t[0],this._y=t[1]):(this._x=t.x,this._y=t.y)}toArray(){return[this._x,this._y]}get x(){return this._x}get y(){return this._y}sub(t){return new w([this._x-t._x,this._y-t._y])}add(t){return new w([this._x+t._x,this._y+t._y])}mul(t){return t instanceof w?new w([this._x*t._x,this._y*t._y]):new w([this._x*t,this._y*t])}dot(t){return this._x*t._x+this._y*t._y}lengthSq(){return this._x*this._x+this._y*this._y}static one=new w([1,1]);static zero=new w([0,0]);normalize(){return this.mul(1/Math.sqrt(this.lengthSq()))}length(){return Math.sqrt(this.lengthSq())}}class h{_x;_y;_z;constructor(t){t instanceof Array?(this._x=t[0],this._y=t[1],this._z=t[2]):(this._x=t.x,this._y=t.y,this._z=t.z)}add(t){return new h([this._x+t._x,this._y+t._y,this._z+t._z])}sub(t){return new h([this._x-t._x,this._y-t._y,this._z-t._z])}mul(t){return t instanceof h?new h([this._x*t._x,this._y*t._y,this._z*t._z]):new h([this._x*t,this._y*t,this._z*t])}cross(t){return new h({x:this._y*t.z-this._z*t.y,y:this._z*t.x-this._x*t.z,z:this._x*t.y-this._y*t.x})}div(t){if(t==0)throw new Error("do not divide by 0");return new h([this._x/t,this._y/t,this._z/t])}negative(){return new h([-this._x,-this._y,-this._z])}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z}lengthSquare(){return this._x*this._x+this._y*this._y+this._z*this._z}length(){return Math.sqrt(this.lengthSquare())}normalize(){let t=this.length();return t==0?h.zero:this.mul(1/t)}angle(t){let e=Math.sqrt(this.lengthSquare()*t.lengthSquare());return Math.acos(this.dot(t)/e)}project(t){let e=t.dot(this),s=this.lengthSquare();return this.mul(e/s)}perpendicular(t){return t.sub(this.project(t))}reflection(t){let e=this.dot(t);return this.sub(t.mul(e*2))}toMatrix(){return new x([[this.x],[this.y],[this.z]])}copy(){return new h([this._x,this._y,this._z])}getByName(t){switch(t){case"x":return this.x;case"y":return this.y;case"z":return this.z}}get z(){return this._z}get y(){return this._y}get x(){return this._x}static zero=new h([0,0,0]);static one=new h([1,1,1]);static forward=new h([0,0,1]);static up=new h([0,1,0]);toArray(){return[this._x,this._y,this._z]}toVec2XZ(){return new w([this.x,this.z])}}class z{_x;_y;_z;_w;constructor(t){t instanceof Array?(this._x=t[0],this._y=t[1],this._z=t[2],this._w=t[3]):(this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w)}add(t){return new z([this._x+t._x,this._y+t._y,this._z+t._z,this._w+t._w])}mul(t){if(t instanceof h){const e=this.w*t.x+this.y*t.z-this.z*t.y,s=this.w*t.y+this.z*t.x-this.x*t.z,i=this.w*t.z+this.x*t.y-this.y*t.x,n=-this.x*t.x-this.y*t.y-this.z*t.z;return new h([e*this.w+n*-this.x+s*-this.z-i*-this.y,s*this.w+n*-this.y+i*-this.x-e*-this.z,i*this.w+n*-this.z+e*-this.y-s*-this.x])}else return new z([this.x*t.w+this.w*t.x+this.y*t.z-this.z*t.y,this.y*t.w+this.w*t.y+this.z*t.x-this.x*t.z,this.z*t.w+this.w*t.z+this.x*t.y-this.y*t.x,this.w*t.w-this.x*t.x-this.y*t.y-this.z*t.z])}negative(){return new z([-this._x,-this._y,-this._z,this._w])}get w(){return this._w}get z(){return this._z}get y(){return this._y}get x(){return this._x}static zero=new z([0,0,0,1]);static setFromEuler(t){const e=Math.cos(t.x/2),s=Math.cos(t.y/2),i=Math.cos(t.z/2),n=Math.sin(t.x/2),a=Math.sin(t.y/2),o=Math.sin(t.z/2);return new z([n*s*i+e*a*o,e*a*i-n*s*o,e*s*o+n*a*i,e*s*i-n*a*o])}static lookAt(t,e){let s=e.sub(t).normalize(),i=h.up.cross(s).normalize(),n=s.cross(i);return new J([[i.x,n.x,s.x],[i.y,n.y,s.y],[i.z,n.z,s.z]])}static getQuaternionFromMatrix(t){let e=Math.sqrt(Math.max(0,1+t.get(0,0)+t.get(1,1)+t.get(2,2)))/2,s=Math.sqrt(Math.max(0,1+t.get(0,0)-t.get(1,1)-t.get(2,2)))/2,i=Math.sqrt(Math.max(0,1-t.get(0,0)+t.get(1,1)-t.get(2,2)))/2,n=Math.sqrt(Math.max(0,1-t.get(0,0)-t.get(1,1)+t.get(2,2)))/2;return s*=Math.sign(s*(t.get(2,1)-t.get(1,2))),i*=Math.sign(i*(t.get(0,2)-t.get(2,0))),n*=Math.sign(n*(t.get(1,0)-t.get(0,1))),new z([s,i,n,e])}static getSqrt(t){if(t==0||t==1)return t;if(t==-1)return-1;let e=1e-6,s=t;for(;s-t/s>e;)s=(s-t/s)/2;return s}toArray(){return[this._x,this._y,this._z,this._w]}}class V{position;rotation;scale;_modules;constructor({position:t,rotation:e,scale:s}){this._modules=[],this.position=t||h.zero,this.rotation=e||h.zero,this.scale=s||h.one}addModule(t){t.modelOwner=this,this._modules.push(t),this._modules.sort((e,s)=>e.important-s.important)}update(t){this._modules.forEach(e=>e.update(t))}get modules(){return this._modules}getQuaternionRotation(){return z.setFromEuler(this.rotation)}}class F{_important;modelOwner=null;constructor(t=0){this._important=t}get important(){return this._important}}var et=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,t=arguments.length;t--;)r+=arguments[t]*arguments[t];return Math.sqrt(r)});function D(){var r=new et(16);return et!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function ht(r,t){if(r===t){var e=t[1],s=t[2],i=t[3],n=t[6],a=t[7],o=t[11];r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=e,r[6]=t[9],r[7]=t[13],r[8]=s,r[9]=n,r[11]=t[14],r[12]=i,r[13]=a,r[14]=o}else r[0]=t[0],r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=t[1],r[5]=t[5],r[6]=t[9],r[7]=t[13],r[8]=t[2],r[9]=t[6],r[10]=t[10],r[11]=t[14],r[12]=t[3],r[13]=t[7],r[14]=t[11],r[15]=t[15];return r}function st(r,t){var e=t[0],s=t[1],i=t[2],n=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8],m=t[9],d=t[10],f=t[11],y=t[12],v=t[13],p=t[14],C=t[15],b=e*o-s*a,P=e*u-i*a,O=e*l-n*a,E=s*u-i*o,R=s*l-n*o,I=i*l-n*u,U=c*v-m*y,X=c*p-d*y,N=c*C-f*y,Y=m*p-d*v,Z=m*C-f*v,j=d*C-f*p,g=b*j-P*Z+O*Y+E*N-R*X+I*U;return g?(g=1/g,r[0]=(o*j-u*Z+l*Y)*g,r[1]=(i*Z-s*j-n*Y)*g,r[2]=(v*I-p*R+C*E)*g,r[3]=(d*R-m*I-f*E)*g,r[4]=(u*N-a*j-l*X)*g,r[5]=(e*j-i*N+n*X)*g,r[6]=(p*O-y*I-C*P)*g,r[7]=(c*I-d*O+f*P)*g,r[8]=(a*Z-o*N+l*U)*g,r[9]=(s*N-e*Z-n*U)*g,r[10]=(y*R-v*O+C*b)*g,r[11]=(m*O-c*R-f*b)*g,r[12]=(o*X-a*Y-u*U)*g,r[13]=(e*Y-s*X+i*U)*g,r[14]=(v*P-y*E-p*b)*g,r[15]=(c*E-m*P+d*b)*g,r):null}function ct(r,t,e){var s=t[0],i=t[1],n=t[2],a=t[3],o=s+s,u=i+i,l=n+n,c=s*o,m=s*u,d=s*l,f=i*u,y=i*l,v=n*l,p=a*o,C=a*u,b=a*l;return r[0]=1-(f+v),r[1]=m+b,r[2]=d-C,r[3]=0,r[4]=m-b,r[5]=1-(c+v),r[6]=y+p,r[7]=0,r[8]=d+C,r[9]=y-p,r[10]=1-(c+f),r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function ut(r,t,e,s){var i=t[0],n=t[1],a=t[2],o=t[3],u=i+i,l=n+n,c=a+a,m=i*u,d=i*l,f=i*c,y=n*l,v=n*c,p=a*c,C=o*u,b=o*l,P=o*c,O=s[0],E=s[1],R=s[2];return r[0]=(1-(y+p))*O,r[1]=(d+P)*O,r[2]=(f-b)*O,r[3]=0,r[4]=(d-P)*E,r[5]=(1-(m+p))*E,r[6]=(v+C)*E,r[7]=0,r[8]=(f+b)*R,r[9]=(v-C)*R,r[10]=(1-(m+y))*R,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function dt(r,t,e,s,i){var n=1/Math.tan(t/2),a;return r[0]=n/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=n,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,i!=null&&i!==1/0?(a=1/(s-i),r[10]=(i+s)*a,r[14]=2*i*s*a):(r[10]=-1,r[14]=-2*s),r}var mt=dt,B=(r=>(r[r.MOUSE_MOVE=0]="MOUSE_MOVE",r[r.MOUSE_CLICK=1]="MOUSE_CLICK",r[r.KEYBOARD_CLICK=2]="KEYBOARD_CLICK",r))(B||{});class _{static _instance=null;canvas;mousePosition=new w([0,0]);mouseMoment=new w([0,0]);mousePressButton=[];keyPressButton=[];registeredFunction=new Map;constructor(){if(_._instance!=null)return _._instance;let t=S.instance?.canvasDOM;if(t==null)throw new Error("Canvas not found");this.canvas=t,this.canvas.addEventListener("mousemove",this.mouseover.bind(this)),this.canvas.addEventListener("mousedown",this.mousedown.bind(this)),this.canvas.addEventListener("mouseup",this.mouseup.bind(this)),window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this)),_._instance=this}runEvent(t,e){(this.registeredFunction.get(t)||[]).forEach(i=>i(e))}resetMovement(){this.mouseMoment=new w([0,0])}mouseover(t){let e=t.x-this.canvas.getBoundingClientRect().x,s=t.y-this.canvas.getBoundingClientRect().y;this.mousePosition=new w([e,s]),this.mouseMoment=new w([t.movementX,t.movementY]),this.runEvent(B.MOUSE_MOVE,t)}mousedown(t){this.mousePressButton.push(t.button),this.runEvent(B.MOUSE_CLICK,t)}mouseup(t){this.mousePressButton=this.mousePressButton.filter(e=>e!=t.button),this.runEvent(B.MOUSE_CLICK,t)}keydown(t){this.keyPressButton.some(e=>e===t.key)||this.keyPressButton.push(t.key),this.runEvent(B.KEYBOARD_CLICK,t)}keyup(t){this.keyPressButton=this.keyPressButton.filter(e=>e!=t.key),this.runEvent(B.KEYBOARD_CLICK,t)}registerEvent(t,e){this.registeredFunction.has(t)||this.registeredFunction.set(t,[]);let s=this.registeredFunction.get(t);if(s!=null){let i=s.length;return s.push(e),this.registeredFunction.set(t,s),i}return-1}unRegisterEvent(t,e){let s=this.registeredFunction.get(t);s!=null&&(s=s.filter((i,n)=>n!==e),this.registeredFunction.set(t,s))}getMouseMoment(){return this.mouseMoment}getMousePosition(){return this.mousePosition}getKeyPress(){return this.keyPressButton}isMouseButtonClick(t){return this.mousePressButton.some(e=>e!=t)}isKeyButtonPress(t){return this.keyPressButton.some(e=>e===t)}mouseLock(){this.canvas.requestPointerLock()}mouseUnlock(){document.exitPointerLock()}static get instance(){return this._instance==null&&(this._instance=new _),this._instance}}class T{static _instance;canvasController;_models;isRunning;lastTime;timeScale=1;_mainCamera=null;_mapController=null;constructor(t){T._instance=this,_.instance,this.canvasController=t,this.isRunning=!1,this.lastTime=-1,this._models=[]}start(t){this.isRunning=!0,this.gameLoop(t),this.lastTime=Date.now()}stop(){this.isRunning=!1}addModel(t){this._models.push(t)}gameLoop(t){if(!this.isRunning)return;let e=(Date.now()-this.lastTime)/1e3*this.timeScale;this.lastTime=Date.now();let s=this.canvasController.canvasCtx;s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.clearColor(.5,.5,.5,.9),s.clearDepth(1),s.viewport(0,0,this.canvasController.canvasDOM.width,this.canvasController.canvasDOM.height),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),this._mapController!==null&&this._mapController.clear(),this._models.forEach(i=>i.update(e)),t(e),_.instance.resetMovement(),requestAnimationFrame(()=>this.gameLoop(t))}addMapController(t){this._mapController=t}static get instance(){return this._instance}get models(){return this._models}get mapController(){return this._mapController}get mainCamera(){return this._mainCamera}set mainCamera(t){this._mainCamera=t}removeModel(t){this._models=this._models.filter(e=>e!=t)}}class ft extends F{fov;aspect;near;far;_perspective;constructor({fov:t,aspect:e,near:s,far:i}){super(10),this.fov=t,this.aspect=e||S.instance?.getAspect()||window.innerWidth/window.innerHeight,this.near=s,this.far=i,this._perspective=D(),this.calcPerspective()}setAsMainCamera(){T.instance.mainCamera=this}getViewMatrix(){let t=this.modelOwner,e=D();return t&&ct(e,z.setFromEuler(t.rotation).toArray(),t.position.toArray()),e}calcPerspective(){this._perspective=D(),mt(this._perspective,this.fov*Math.PI/180,this.aspect,this.near,this.far)}update(t){}get perspective(){return this._perspective}}class M{_r;_g;_b;_a;constructor(t){t instanceof Array?(this._r=t[0],this._g=t[1],this._b=t[2],this._a=t[3]):(this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a)}toString(){return`rgba(${this._r},${this._g},${this._b},${this._a})`}get r(){return this._r}set r(t){this._r=t}get g(){return this._g}set g(t){this._g=t}get b(){return this._b}set b(t){this._b=t}get a(){return this._a}set a(t){this._a=t}static BLACK=new M([0,0,0,1]);static WHITE=new M([255,255,255,1]);static YELLOW=new M([255,255,0,1]);static randomColor(){let t=Math.floor(Math.random()*256),e=Math.floor(Math.random()*256),s=Math.floor(Math.random()*256);return new M([t,e,s,1])}}class L extends F{static colliders=[];_isCollide=!1;_collisionsObjects=[];_colliderName;whenCollide;constructor(t,e){super(101),L.colliders.push(this),this._colliderName=t,this.whenCollide=e,this._isCollide=!1}update(t){this._isCollide=!1,this._collisionsObjects=[],L.colliders.forEach(e=>{e!=this&&this.checkCollision(e)})}get isCollide(){return this._isCollide}get colliderName(){return this._colliderName}get collisionsObjects(){return this._collisionsObjects}}class rt extends L{_size;constructor({size:t,whenCollide:e}){super("rectXZ",e||(()=>{})),this._size=t}checkCollision(t){switch(t.colliderName){case"circleXZ":this.checkCollisionCircleXZ(t)&&(this._isCollide=!0,this.collisionsObjects.push(t),this.whenCollide());break}}checkCollisionCircleXZ(t){let e=this.modelOwner,s=t.modelOwner;if(e==null||s==null)return!1;let i=new w([e.position.x,e.position.z]).sub(this.size),n=new w([e.position.x,e.position.z]).add(this.size),a={x:s.position.x,y:s.position.z};return a.x<i.x?a.x=i.x:a.x>n.x&&(a.x=n.x),a.y<i.y?a.y=i.y:a.y>n.y&&(a.y=n.y),new w(a).sub(new w([s.position.x,s.position.z])).lengthSq()<=t.radius*t.radius}get size(){let t=new w([this.modelOwner?.scale.x||1,this.modelOwner?.scale.z||1]);return this._size.mul(t)}}class K extends L{_radius;constructor({radius:t,whenCollide:e}){super("circleXZ",e||(()=>{})),this._radius=t}checkCollision(t){switch(t.colliderName){case"circleXZ":this.checkCollisionCircleXZ(t)&&(this._isCollide=!0,this.collisionsObjects.push(t),this.whenCollide());break;case"rectXZ":t.checkCollisionCircleXZ(this)&&(this._isCollide=!0,this.collisionsObjects.push(t),this.whenCollide())}}checkCollisionCircleXZ(t){let e=this.modelOwner,s=t.modelOwner;if(e==null||s==null)return!1;let n=s.position.toVec2XZ().sub(e.position.toVec2XZ()).lengthSq(),a=this.radius+t.radius;return n<a*a}get radius(){return this._radius}}class nt extends F{movementSpeed;sensitivity;constructor({movementSpeed:t,sensitivity:e}){super(102),this.movementSpeed=t,this.sensitivity=e,S.instance?.canvasDOM.addEventListener("click",()=>_.instance.mouseLock())}repairPosition(){if(this.modelOwner==null)return;let t=this.modelOwner.modules.filter(e=>e instanceof L&&e.isCollide);if(t.length>0){let e=new w([0,0]);t.forEach(s=>{s instanceof K&&(s.collisionsObjects.forEach(i=>{if(i==s||!(i instanceof rt))return;let n=i,a=n.modelOwner;if(this.modelOwner==null||a==null)return;let o=a.position.toVec2XZ().sub(n.size),u=a.position.toVec2XZ().add(n.size),l=[this.modelOwner.position.x,this.modelOwner.position.z];l[0]=l[0]<o.x?o.x:l[0],l[1]=l[1]<o.y?o.y:l[1],l[0]=l[0]>u.x?u.x:l[0],l[1]=l[1]>u.y?u.y:l[1];let c=new w(l),m=c.sub(this.modelOwner.position.toVec2XZ()).lengthSq(),d;m==0?d=c.sub(a.position.toVec2XZ()).normalize():d=this.modelOwner.position.toVec2XZ().sub(c).normalize();let f=[0,0];d.x!=0?f[0]=(s.radius+n.size.x-Math.abs(this.modelOwner.position.x-a.position.x))*d.x:d.y!=0&&(f[1]=(s.radius+n.size.y-Math.abs(this.modelOwner.position.z-a.position.z))*d.y),e=e.add(new w(f))}),this.modelOwner&&(this.modelOwner.position=this.modelOwner.position.add(new h([e.x,0,e.y]))))})}}update(t){if(this.modelOwner==null)return;let e=[0,0,0];_.instance.isKeyButtonPress("w")&&(e[2]=-1),_.instance.isKeyButtonPress("s")&&(e[2]=1),_.instance.isKeyButtonPress("d")&&(e[0]=1),_.instance.isKeyButtonPress("a")&&(e[0]=-1);let s=z.setFromEuler(this.modelOwner.rotation).mul(new h(e));this.modelOwner.position=this.modelOwner.position.add(s.mul(this.movementSpeed*t));let i=_.instance.getMouseMoment();this.modelOwner.rotation=this.modelOwner.rotation.add(new h([0,-i.x,0]).mul(this.sensitivity*t))}clip(t,e,s){return t<e?e:t>s?s:t}}class k extends F{Pmatrix=null;Vmatrix=null;Mmatrix=null;normalMatrix=null;index_buffer=null;shaderProgram=null;vertex_buffer=null;normal_buffer=null;color_buffer=null;mesh;texture;constructor({mesh:t,texture:e}){super(100),this.mesh=t,this.texture=e,this.texture.calculatingColor(this.mesh.vertices),this.init()}init(){let t=S.instance?.canvasCtx;if(!!t){this.vertex_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertex_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.mesh.vertices),t.STATIC_DRAW),this.normal_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.normal_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.mesh.vertices),t.STATIC_DRAW),this.color_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.color_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.texture.colorVertices),t.STATIC_DRAW),this.index_buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.index_buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.mesh.triangles),t.STATIC_DRAW);var e="attribute vec3 position;attribute vec3 normal;uniform mat4 Pmatrix;uniform mat4 Vmatrix;uniform mat4 Mmatrix;uniform mat4 uNormalMatrix;attribute vec3 color;varying vec3 vColor;varying vec3 vLighting;void main(void) { gl_Position = Pmatrix*Vmatrix*Mmatrix*vec4(position, 1.);vColor = color;highp vec3 ambientLight = vec3(0.3, 0.3,0.3);highp vec3 directionalLightColor = vec3(1, 0.2, 0.2);highp vec3 directionalVector = normalize(vec3(0, 5, 0));highp vec4 transformedNormal = uNormalMatrix * vec4(normal, 1.0);highp float directional = max(dot(transformedNormal.xyz, directionalVector), 0.0);vLighting = ambientLight + (directionalLightColor * directional);}",s="precision mediump float;varying vec3 vColor;varying highp vec3 vLighting;void main(void) {gl_FragColor = vec4(vColor*vLighting, 1.);}",i=t.createShader(t.VERTEX_SHADER);if(!!i){t.shaderSource(i,e),t.compileShader(i);var n=t.createShader(t.FRAGMENT_SHADER);!n||(t.shaderSource(n,s),t.compileShader(n),this.shaderProgram=t.createProgram(),this.shaderProgram&&(t.attachShader(this.shaderProgram,i),t.attachShader(this.shaderProgram,n),t.linkProgram(this.shaderProgram)))}}}update(t){let e=this.modelOwner;if(!e)return;let s=S.instance;if(!s||!this.shaderProgram)return;let i=s.canvasCtx;const n=D();ut(n,e.getQuaternionRotation().toArray(),e.position.toArray(),e.scale.toArray());let a=T.instance.mainCamera;if(!a)return;let o=D();st(o,a.getViewMatrix());const u=D();st(u,n),ht(u,u),this.Pmatrix=i.getUniformLocation(this.shaderProgram,"Pmatrix"),this.Vmatrix=i.getUniformLocation(this.shaderProgram,"Vmatrix"),this.Mmatrix=i.getUniformLocation(this.shaderProgram,"Mmatrix"),this.normalMatrix=i.getUniformLocation(this.shaderProgram,"uNormalMatrix"),i.bindBuffer(i.ARRAY_BUFFER,this.vertex_buffer);var l=i.getAttribLocation(this.shaderProgram,"position");i.vertexAttribPointer(l,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(l),i.bindBuffer(i.ARRAY_BUFFER,this.normal_buffer);var c=i.getAttribLocation(this.shaderProgram,"normal");i.vertexAttribPointer(c,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(c),i.bindBuffer(i.ARRAY_BUFFER,this.color_buffer);var m=i.getAttribLocation(this.shaderProgram,"color");i.vertexAttribPointer(m,3,i.FLOAT,!1,0,0),i.enableVertexAttribArray(m),i.useProgram(this.shaderProgram),i.uniformMatrix4fv(this.Pmatrix,!1,a.perspective),i.uniformMatrix4fv(this.Vmatrix,!1,o),i.uniformMatrix4fv(this.Mmatrix,!1,n),i.uniformMatrix4fv(this.normalMatrix,!1,u),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,this.index_buffer),i.drawElements(i.TRIANGLES,this.mesh.triangles.length,i.UNSIGNED_SHORT,0)}}class wt{_vertices;_triangles;_normals;constructor(t){this._vertices=t?.vertices?.reduce((e,s)=>[...e,...s],[])||[],this._triangles=t?.triangles?.reduce((e,s)=>[...e,...s],[])||[],this._normals=t?.normal?.reduce((e,s)=>[...e,...s],[])||[]}get vertices(){return this._vertices}get triangles(){return this._triangles}get normals(){return this._normals}}class gt extends wt{constructor(){super({vertices:[],triangles:[],normal:[]})}addVertex(t){this.vertices.push(...t)}addTriangle(t){this.triangles.push(...t)}addNormal(t){this.normals.push(...t)}}const Q={parse(r){let t=new gt,e=[],s=[];const i={v(o){s.push(o.map(parseFloat))},vn(o){e.push(o.map(parseFloat))},vt(o){},f(o){const u=o.length-2;for(let l=0;l<u;++l){let c=[o[0],o[l+1],o[l+2]].map(d=>{let f=d.split("/");return s[parseInt(f[0])-1]});t.addVertex(c[0]),t.addVertex(c[1]),t.addVertex(c[2]);let m=t.triangles[t.triangles.length-1]||-1;t.addTriangle([m+1,m+2,m+3]),t.addNormal([o[0],o[l+1],o[l+2]].map(d=>{let f=d.split("/");return f[2]==null?[0,0,0]:e[parseInt(f[2])-1]}).reduce((d,f)=>[...d,...f],[]))}}},n=/(\w*)(?: )*(.*)/,a=r.split(`
`);for(let o=0;o<a.length;++o){const u=a[o].trim();if(u===""||u.startsWith("#"))continue;const l=n.exec(u);if(!l)continue;const[,c]=l,m=u.split(/\s+/).slice(1),d=i[c];if(!d){console.warn("unhandled keyword:",c);continue}d(m)}return t}},tt={async load(r){return(await fetch(r)).text()}};let $=Q.parse(await tt.load("resources/models/cube.obj"));Q.parse(await tt.load("resources/models/ghost.obj"));let xt=Q.parse(await tt.load("resources/models/ball.obj"));class _t{_colorVertices;constructor(){this._colorVertices=[]}get colorVertices(){return this._colorVertices}}class H extends _t{color;constructor(t){super(),this.color=t}calculatingColor(t){this._colorVertices=[];for(let e=0;e<t.length/3;e++)this._colorVertices.push(this.color.r/255,this.color.g/255,this.color.b/255)}}class yt extends F{mapController;size;color;constructor({mapController:t,size:e,color:s}){super(),this.mapController=t,this.size=e,this.color=s||M.WHITE}update(t){if(this.modelOwner==null)return;let e=this.modelOwner.position.toVec2XZ(),s=this.size.mul(this.modelOwner.scale.toVec2XZ());this.mapController.drawRect(e,s,this.color)}}class vt extends F{mapController;radius;color;constructor({mapController:t,radius:e,color:s}){super(),this.mapController=t,this.radius=e,this.color=s||M.WHITE}update(t){if(this.modelOwner==null)return;let e=this.modelOwner.position.toVec2XZ();this.mapController.drawCircle(e,this.radius,this.color)}}class A{static _instance=null;score;maxPoints;collectedPoints;static get instance(){return this._instance==null&&(this._instance=new A),this._instance}constructor(){A._instance=this,this.maxPoints=0,this.collectedPoints=0,this.score=0}increaseMaxPoints(){this.maxPoints++}collectPoint(){this.collectedPoints++,this.collectedPoints>=this.maxPoints&&alert("YOU WIN with score: "+this.score)}addScore(t){this.score+=t}draw(t){t.drawText("Your score: "+this.score,new w([0,30]),30,M.WHITE)}}class q extends V{constructor({position:t,mapController:e}){super({position:t,rotation:h.zero,scale:new h([.5,.5,.5])}),A.instance.increaseMaxPoints();let s=new k({mesh:xt,texture:new H(M.YELLOW)});this.addModule(s);let i=new K({radius:1,whenCollide:()=>{let n=this.modules.filter(a=>a instanceof L&&a.isCollide);n.length>0&&n.forEach(a=>{a instanceof K&&a.collisionsObjects.forEach(o=>{if(o!=a&&o.modelOwner!=null&&o.modelOwner.modules.find(u=>u instanceof nt)){if(console.log("PLAYER"),this==null)return;T.instance.removeModel(this),A.instance.collectPoint(),A.instance.addScore(200)}})})}});this.addModule(i),e!=null&&this.addModule(new vt({mapController:e,radius:3,color:M.YELLOW}))}}class pt{generatePoints(t,e,s,i){let n=[],a=(u,l)=>n[u]==null||n[u][l]==null?!1:n[u][l],o=(u,l,c)=>{n[u]==null&&(n[u]=[]),n[u][l]=c};t.forEach((u,l)=>{u.forEach((c,m)=>{let d=new h([(l-t.length/2+.5)*e*2,2,(m-t[0].length/2+.5)*e*2]);(c&1)==0&&!a(l-.5,m)&&l-.5>0&&(s.addModel(new q({position:d.add(new h([-e,0,0])),mapController:i})),o(l-.5,m,!0)),(c&2)==0&&!a(l,m+.5)&&m+.5<t[0].length-1&&(s.addModel(new q({position:d.add(new h([0,0,e])),mapController:i})),o(l,m+.5,!0)),(c&4)==0&&!a(l+.5,m)&&l+.5<t.length-1&&(s.addModel(new q({position:d.add(new h([e,0,0])),mapController:i})),o(l+.5,m,!0)),(c&8)==0&&!a(l,m-.5)&&m-.5>0&&(s.addModel(new q({position:d.add(new h([0,0,-e])),mapController:i})),o(l,m-.5,!0))})})}}class Ct extends T{tileSize;wallHeight;wallColor;floorColor;constructor({canvasController:t,mapController:e,mapMask:s,tileSize:i,wallHeight:n,wallColor:a,floorColor:o}){super(t),this.addMapController(e),this.tileSize=i||1,this.wallHeight=n||1,this.wallColor=a,this.floorColor=o,this.generateMap(s)}createWall(t,e,s){let i=new V({position:t,rotation:h.zero,scale:s});i.addModule(new k({mesh:$,texture:new H(e)})),this.mapController!=null&&i.addModule(new yt({mapController:this.mapController,size:w.one})),i.addModule(new rt({size:w.one})),this.addModel(i)}generateMap(t){let e=new V({position:h.zero,rotation:h.zero,scale:new h([this.tileSize*t.length,.5,this.tileSize*t[0].length])});e.addModule(new k({mesh:$,texture:new H(this.floorColor)})),this.addModel(e);let s=new V({position:h.zero.add(new h([0,this.wallHeight*2,0])),rotation:h.zero,scale:new h([this.tileSize*t.length,.5,this.tileSize*t[0].length])});s.addModule(new k({mesh:$,texture:new H(this.floorColor)})),this.addModel(s),[[1,0],[-1,0],[0,1],[0,-1]].forEach(l=>{this.createWall(new h([this.tileSize*t.length*l[0],.5+this.wallHeight/2,this.tileSize*t[0].length*l[1]]),this.wallColor,new h([l[0]==0?this.tileSize*t.length:.5,this.wallHeight,l[1]==0?this.tileSize*t[0].length:.5]))});let n=[],a=(l,c)=>n[l]==null||n[l][c]==null?!1:n[l][c],o=(l,c,m)=>{n[l]==null&&(n[l]=[]),n[l][c]=m};t.forEach((l,c)=>{l.forEach((m,d)=>{let f=new h([(c-t.length/2+.5)*this.tileSize*2,1.5,(d-t[0].length/2+.5)*this.tileSize*2]);(m&1)>0&&!a(c-.5,d)&&(this.createWall(new h([f.x-this.tileSize,f.y,f.z]),this.wallColor,new h([.5,this.wallHeight,this.tileSize+.5])),o(c-.5,d,!0)),(m&2)>0&&!a(c,d+.5)&&(this.createWall(new h([f.x,f.y,f.z+this.tileSize]),this.wallColor,new h([this.tileSize+.5,this.wallHeight,.5])),o(c,d+.5,!0)),(m&4)>0&&!a(c+.5,d)&&(this.createWall(new h([f.x+this.tileSize,f.y,f.z]),this.wallColor,new h([.5,this.wallHeight,this.tileSize+.5])),o(c+.5,d,!0)),(m&8)>0&&!a(c,d-.5)&&(this.createWall(new h([f.x,f.y,f.z-this.tileSize]),this.wallColor,new h([this.tileSize+.5,this.wallHeight,.5])),o(c,d-.5,!0))})}),new pt().generatePoints(t,this.tileSize,this,this.mapController)}}class Mt{canvasDOM;canvasCtx;width;height;translateMap;scale;isRotate90;constructor({elementName:t,translateMap:e,scale:s,isRotate90:i}){let n=document.querySelector(t);if(n==null)throw new Error("Element must exist");this.canvasDOM=n,this.width=this.canvasDOM.width,this.height=this.canvasDOM.height;let a=this.canvasDOM.getContext("2d");if(a==null)throw new Error("Element must exist");this.canvasCtx=a,this.translateMap=e,this.scale=s,this.isRotate90=i}clear(){this.canvasCtx.clearRect(0,0,this.width,this.height)}drawRect(t,e,s){let i=t.sub(e).mul(this.scale).add(this.translateMap).add(new w([this.width/2,this.height/2])),n=e.mul(2).mul(this.scale);this.canvasCtx.fillStyle=s.toString(),this.isRotate90?this.canvasCtx.fillRect(i.y,i.x,n.y,n.x):this.canvasCtx.fillRect(i.x,i.y,n.x,n.y)}drawCircle(t,e,s){let i=t.mul(this.scale).add(this.translateMap).add(new w([this.width/2,this.height/2]));this.canvasCtx.fillStyle=s.toString(),this.isRotate90&&(i=new w([i.y,i.x])),this.canvasCtx.beginPath(),this.canvasCtx.fillStyle=s.toString(),this.canvasCtx.arc(i.x,i.y,e,0,2*Math.PI),this.canvasCtx.fill()}drawImage(t,e,s,i){let n=e.mul(this.scale).add(this.translateMap).add(new w([this.width/2,this.height/2]));this.isRotate90&&(n=new w([n.y,n.x])),this.canvasCtx.save(),this.canvasCtx.translate(n.x,n.y),this.canvasCtx.rotate(-s),this.canvasCtx.drawImage(t,-i.x/2,-i.y/2,i.x,i.y),this.canvasCtx.restore()}drawText(t,e,s,i){let n=e.mul(this.scale).add(this.translateMap);this.isRotate90&&(n=new w([n.y,n.x])),this.canvasCtx.fillStyle=i.toString(),this.canvasCtx.font=`${s}px`,this.canvasCtx.fillText(t,n.x,n.y)}}class bt extends F{mapController;canRotation;image;isImageLoaded=!1;size;constructor({mapController:t,imageSrc:e,canRotation:s,size:i}){super(),this.size=i,this.mapController=t,this.canRotation=s||!1,this.image=new Image,this.image.src=e,this.image.addEventListener("load",()=>{this.isImageLoaded=!0})}update(t){if(this.modelOwner==null||!this.isImageLoaded)return;let e=this.modelOwner.position.toVec2XZ();this.mapController.drawImage(this.image,e,-(this.canRotation?this.modelOwner.rotation.y+Math.PI:0),this.size)}}class zt{canvasDOM;canvasCtx;width;height;constructor({elementName:t}){let e=document.querySelector(t);if(e==null)throw new Error("Element must exist");this.canvasDOM=e,this.width=this.canvasDOM.width,this.height=this.canvasDOM.height;let s=this.canvasDOM.getContext("2d");if(s==null)throw new Error("Element must exist");this.canvasCtx=s}clear(){this.canvasCtx.clearRect(0,0,this.width,this.height)}drawRect(t,e,s){let i=t.sub(e);this.canvasCtx.fillStyle=s.toString(),this.canvasCtx.fillRect(i.y,i.x,e.y,e.x)}drawCircle(t,e,s){this.canvasCtx.fillStyle=s.toString(),this.canvasCtx.beginPath(),this.canvasCtx.fillStyle=s.toString(),this.canvasCtx.arc(t.x,t.y,e,0,2*Math.PI),this.canvasCtx.fill()}drawImage(t,e,s,i){this.canvasCtx.save(),this.canvasCtx.translate(e.x,e.y),this.canvasCtx.rotate(-s),this.canvasCtx.drawImage(t,-i.x/2,-i.y/2,i.x,i.y),this.canvasCtx.restore()}drawText(t,e,s,i){this.canvasCtx.fillStyle=i.toString(),this.canvasCtx.font=`${s}px sans-serif`,this.canvasCtx.fillText(t,e.x,e.y)}}let Ot=new S("#mainCanvas"),at=new Mt({elementName:"#mapCanvas",translateMap:new w([-220,300]),scale:new w([5,5]),isRotate90:!0}),it=new zt({elementName:"#infoCanvas"}),lt=new Ct({canvasController:Ot,mapController:at,mapMask:[[0,4,2,8,4,4,4,4,2,8,4,0],[2,9,4,0,5,1,1,5,0,4,3,8],[0,0,5,2,13,4,4,7,8,5,0,0],[2,12,1,0,5,5,5,5,0,1,6,8],[0,1,2,8,1,1,1,1,2,8,1,0]],tileSize:3,wallHeight:2,wallColor:M.randomColor(),floorColor:M.randomColor()}),W=new V({position:new h([2,2,0]),rotation:new h([0,0,0])}),ot=new ft({fov:60,near:.01,far:1e3}),G=new nt({movementSpeed:5,sensitivity:5}),Et=new bt({mapController:at,imageSrc:"pacman.png",size:new w([10,10]),canRotation:!0}),Rt=new K({radius:1,whenCollide:G.repairPosition.bind(G)});W.addModule(ot);W.addModule(G);W.addModule(Rt);W.addModule(Et);lt.addModel(W);ot.setAsMainCamera();lt.start(()=>{it.clear(),A.instance.draw(it)});
