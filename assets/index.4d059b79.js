(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerpolicy&&(r.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?r.credentials="include":s.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();class L{_canvasDOM;_canvasCtx;static _instance=null;_proj_matrix;_view_matrix;constructor(t){L._instance=this;let e=document.querySelector(t);if(e==null)throw new Error("Invalid name");this._canvasDOM=e;let i=this._canvasDOM.getContext("webgl2",{antialias:!1});if(i==null)throw new Error("Problem with create Context");let s=i.getContextAttributes();s!=null&&(s.antialias=!1),this._canvasCtx=i,this._canvasCtx.clearColor(0,0,0,1),this._canvasCtx.clear(this._canvasCtx.COLOR_BUFFER_BIT),this._proj_matrix=this.get_projection(40,this._canvasDOM.width/this._canvasDOM.height,1,100),this._view_matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._view_matrix[14]=this._view_matrix[14]-6}static get instance(){return this._instance}get_projection(t,e,i,s){var r=Math.tan(t*.5*Math.PI/180);return[.5/r,0,0,0,0,.5*e/r,0,0,0,0,-(s+i)/(s-i),-1,0,0,-2*s*i/(s-i),0]}get canvasDOM(){return this._canvasDOM}get canvasCtx(){return this._canvasCtx}get proj_matrix(){return this._proj_matrix}get view_matrix(){return this._view_matrix}getAspect(){return this._canvasDOM.width/this._canvasDOM.height}}class O{values;rows;cols;constructor(t){t.length==0?(this.values=[[0]],this.cols=1,this.rows=1):t[0]instanceof Object?(this.values=t,this.rows=t.length,this.cols=t[0].length):(this.values=[t],this.rows=1,this.cols=t.length)}get(t,e){if(e<0||e>this.cols||t<0||t>this.rows)throw new Error(`Out of Matrix[${this.cols},${this.rows}]. You cannot get ${e},${t}`);return this.values[t][e]}transpose(){let t=[];return this.values.forEach((e,i)=>e.forEach((s,r)=>{t[r]==null&&(t[r]=[]),t[r][i]=s})),new O(t)}mul(t){let e=[];if(t instanceof O){if(this.cols!=t.rows)throw new Error("You can multiple matrix which first matrix columns is equal second matrix rows");for(let i=0;i<this.rows;i++)for(let s=0;s<t.cols;s++){e[i]==null&&(e[i]=[]),e[i][s]=0;for(let r=0;r<t.rows;r++)e[i][s]+=this.values[i][r]*t.values[r][s]}}else e=this.values.map(i=>i.map(s=>s*t));return new O(e)}cut(t,e){let i=[],s=0;for(let r=0;r<this.rows;r++)for(let a=0;a<this.cols;a++){if(a==e||r==t)continue;let o=Math.floor(s/(this.cols-1)),f=s%(this.cols-1);i[o]==null&&(i[o]=[]),i[o][f]=this.values[r][a],s++}return new O(i)}minor(){if(this.rows==0&&this.cols==0)return new O([[this.values[1][1],this.values[1][0]],[this.values[0][1],this.values[0][0]]]);let t=[];for(let e=0;e<this.rows;e++)for(let i=0;i<this.cols;i++){t[e]==null&&(t[e]=[]);let s=this.cut(e,i).determinant();if(s==null)throw new Error("I cannot calculate minor");t[e][i]=s}return new O(t)}cofactor(){let t=this.minor();for(let e=0;e<t.rows;e++)for(let i=0;i<t.cols;i++)t.values[e][i]*=(i+e)%2==0?1:-1;return t}adjugate(){return this.cofactor().transpose()}determinant(){if(this.rows==2&&this.cols==2)return this.determinant2x2();if(this.rows==this.cols){let t=this.cofactor(),e=0;for(let i=0;i<this.cols;i++)e+=this.values[0][i]*t.get(i,0);return e}return null}determinant2x2(){return this.values[0][0]*this.values[1][1]-this.values[0][1]*this.values[1][0]}inverse(){if(this.rows!=this.cols)throw new Error("Inverse Matrix can be only from square matrix");let t=this.determinant();return t==0||t==null?null:this.adjugate().mul(1/t)}static makeIdentity(t){let e=[];for(let i=0;i<t;i++)for(let s=0;s<t;s++)e[i]==null&&(e[i]=[]),e[i][s]=s==i?1:0;return new O(e)}toVector3(){return new l([this.get(0,0),this.get(1,0),this.get(2,0)])}}class lt extends O{constructor(t){super(t)}static get identity(){return this.makeIdentity(3)}static get zero(){return new lt([[0,0,0],[0,0,0],[0,0,0]])}static setFromEuler(t){const e=Math.sin,i=Math.cos;let s=new O([[1,0,0],[0,i(t.x),-e(t.x)],[0,e(t.x),i(t.x)]]),r=new O([[i(t.y),0,e(t.y)],[0,1,0],[e(t.y),0,i(t.y)]]),a=new O([[i(t.z),-e(t.z),0],[e(t.z),i(t.z),0],[0,0,1]]);return s.mul(r).mul(a)}}class u{_x;_y;constructor(t){t instanceof Array?(this._x=t[0],this._y=t[1]):(this._x=t.x,this._y=t.y)}toArray(){return[this._x,this._y]}get x(){return this._x}get y(){return this._y}sub(t){return new u([this._x-t._x,this._y-t._y])}add(t){return new u([this._x+t._x,this._y+t._y])}mul(t){return t instanceof u?new u([this._x*t._x,this._y*t._y]):new u([this._x*t,this._y*t])}dot(t){return this._x*t._x+this._y*t._y}lengthSq(){return this._x*this._x+this._y*this._y}static one=new u([1,1]);static zero=new u([0,0]);normalize(){return this.mul(1/Math.sqrt(this.lengthSq()))}length(){return Math.sqrt(this.lengthSq())}equal(t){return this._x===t._x&&this._y===t._y}}class l{_x;_y;_z;constructor(t){t instanceof Array?(this._x=t[0],this._y=t[1],this._z=t[2]):(this._x=t.x,this._y=t.y,this._z=t.z)}add(t){return new l([this._x+t._x,this._y+t._y,this._z+t._z])}sub(t){return new l([this._x-t._x,this._y-t._y,this._z-t._z])}mul(t){return t instanceof l?new l([this._x*t._x,this._y*t._y,this._z*t._z]):new l([this._x*t,this._y*t,this._z*t])}cross(t){return new l({x:this._y*t.z-this._z*t.y,y:this._z*t.x-this._x*t.z,z:this._x*t.y-this._y*t.x})}div(t){if(t==0)throw new Error("do not divide by 0");return new l([this._x/t,this._y/t,this._z/t])}negative(){return new l([-this._x,-this._y,-this._z])}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z}lengthSquare(){return this._x*this._x+this._y*this._y+this._z*this._z}length(){return Math.sqrt(this.lengthSquare())}normalize(){let t=this.length();return t==0?l.zero:this.mul(1/t)}angle(t){let e=Math.sqrt(this.lengthSquare()*t.lengthSquare());return Math.acos(this.dot(t)/e)}project(t){let e=t.dot(this),i=this.lengthSquare();return this.mul(e/i)}perpendicular(t){return t.sub(this.project(t))}reflection(t){let e=this.dot(t);return this.sub(t.mul(e*2))}toMatrix(){return new O([[this.x],[this.y],[this.z]])}copy(){return new l([this._x,this._y,this._z])}getByName(t){switch(t){case"x":return this.x;case"y":return this.y;case"z":return this.z}}get z(){return this._z}get y(){return this._y}get x(){return this._x}static zero=new l([0,0,0]);static one=new l([1,1,1]);static forward=new l([0,0,1]);static up=new l([0,1,0]);toArray(){return[this._x,this._y,this._z]}toVec2XZ(){return new u([this.x,this.z])}}class C{_x;_y;_z;_w;constructor(t){t instanceof Array?(this._x=t[0],this._y=t[1],this._z=t[2],this._w=t[3]):(this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w)}add(t){return new C([this._x+t._x,this._y+t._y,this._z+t._z,this._w+t._w])}mul(t){if(t instanceof l){const e=this.w*t.x+this.y*t.z-this.z*t.y,i=this.w*t.y+this.z*t.x-this.x*t.z,s=this.w*t.z+this.x*t.y-this.y*t.x,r=-this.x*t.x-this.y*t.y-this.z*t.z;return new l([e*this.w+r*-this.x+i*-this.z-s*-this.y,i*this.w+r*-this.y+s*-this.x-e*-this.z,s*this.w+r*-this.z+e*-this.y-i*-this.x])}else return new C([this.x*t.w+this.w*t.x+this.y*t.z-this.z*t.y,this.y*t.w+this.w*t.y+this.z*t.x-this.x*t.z,this.z*t.w+this.w*t.z+this.x*t.y-this.y*t.x,this.w*t.w-this.x*t.x-this.y*t.y-this.z*t.z])}negative(){return new C([-this._x,-this._y,-this._z,this._w])}get w(){return this._w}get z(){return this._z}get y(){return this._y}get x(){return this._x}static zero=new C([0,0,0,1]);static setFromEuler(t){const e=Math.cos(t.x/2),i=Math.cos(t.y/2),s=Math.cos(t.z/2),r=Math.sin(t.x/2),a=Math.sin(t.y/2),o=Math.sin(t.z/2);return new C([r*i*s+e*a*o,e*a*s-r*i*o,e*i*o+r*a*s,e*i*s-r*a*o])}static lookAt(t,e){let i=e.sub(t).normalize(),s=l.up.cross(i).normalize(),r=i.cross(s);return new lt([[s.x,r.x,i.x],[s.y,r.y,i.y],[s.z,r.z,i.z]])}static getQuaternionFromMatrix(t){let e=Math.sqrt(Math.max(0,1+t.get(0,0)+t.get(1,1)+t.get(2,2)))/2,i=Math.sqrt(Math.max(0,1+t.get(0,0)-t.get(1,1)-t.get(2,2)))/2,s=Math.sqrt(Math.max(0,1-t.get(0,0)+t.get(1,1)-t.get(2,2)))/2,r=Math.sqrt(Math.max(0,1-t.get(0,0)-t.get(1,1)+t.get(2,2)))/2;return i*=Math.sign(i*(t.get(2,1)-t.get(1,2))),s*=Math.sign(s*(t.get(0,2)-t.get(2,0))),r*=Math.sign(r*(t.get(1,0)-t.get(0,1))),new C([i,s,r,e])}static getSqrt(t){if(t==0||t==1)return t;if(t==-1)return-1;let e=1e-6,i=t;for(;i-t/i>e;)i=(i-t/i)/2;return i}toArray(){return[this._x,this._y,this._z,this._w]}}class R{_position;_rotation;_scale;_modules;constructor({position:t,rotation:e,scale:i}){this._modules=[],this._position=t||l.zero,this._rotation=e||l.zero,this._scale=i||l.one}addModule(t){t.modelOwner=this,this._modules.push(t),this._modules.sort((e,i)=>e.important-i.important)}update(t){this._modules.forEach(e=>e.update(t))}get modules(){return this._modules}get position(){return this._position}set position(t){this._position=t}get rotation(){return this._rotation}set rotation(t){this._rotation=t}get scale(){return this._scale}set scale(t){this._scale=t}getQuaternionRotation(){return C.setFromEuler(this._rotation)}}class k{_important;modelOwner=null;constructor(t=0){this._important=t}get important(){return this._important}}var ct=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var n=0,t=arguments.length;t--;)n+=arguments[t]*arguments[t];return Math.sqrt(n)});function Z(){var n=new ct(16);return ct!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function _t(n,t){if(n===t){var e=t[1],i=t[2],s=t[3],r=t[6],a=t[7],o=t[11];n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=e,n[6]=t[9],n[7]=t[13],n[8]=i,n[9]=r,n[11]=t[14],n[12]=s,n[13]=a,n[14]=o}else n[0]=t[0],n[1]=t[4],n[2]=t[8],n[3]=t[12],n[4]=t[1],n[5]=t[5],n[6]=t[9],n[7]=t[13],n[8]=t[2],n[9]=t[6],n[10]=t[10],n[11]=t[14],n[12]=t[3],n[13]=t[7],n[14]=t[11],n[15]=t[15];return n}function dt(n,t){var e=t[0],i=t[1],s=t[2],r=t[3],a=t[4],o=t[5],f=t[6],c=t[7],h=t[8],d=t[9],w=t[10],m=t[11],_=t[12],v=t[13],b=t[14],P=t[15],S=e*o-i*a,H=e*f-s*a,A=e*c-r*a,F=i*f-s*o,B=i*c-r*o,q=s*c-r*f,W=h*v-d*_,j=h*b-w*_,Y=h*P-m*_,K=d*b-w*v,$=d*P-m*v,J=w*P-m*b,y=S*J-H*$+A*K+F*Y-B*j+q*W;return y?(y=1/y,n[0]=(o*J-f*$+c*K)*y,n[1]=(s*$-i*J-r*K)*y,n[2]=(v*q-b*B+P*F)*y,n[3]=(w*B-d*q-m*F)*y,n[4]=(f*Y-a*J-c*j)*y,n[5]=(e*J-s*Y+r*j)*y,n[6]=(b*A-_*q-P*H)*y,n[7]=(h*q-w*A+m*H)*y,n[8]=(a*$-o*Y+c*W)*y,n[9]=(i*Y-e*$-r*W)*y,n[10]=(_*B-v*A+P*S)*y,n[11]=(d*A-h*B-m*S)*y,n[12]=(o*j-a*K-f*W)*y,n[13]=(e*K-i*j+s*W)*y,n[14]=(v*H-_*F-b*S)*y,n[15]=(h*F-d*H+w*S)*y,n):null}function yt(n,t,e){var i=t[0],s=t[1],r=t[2],a=t[3],o=i+i,f=s+s,c=r+r,h=i*o,d=i*f,w=i*c,m=s*f,_=s*c,v=r*c,b=a*o,P=a*f,S=a*c;return n[0]=1-(m+v),n[1]=d+S,n[2]=w-P,n[3]=0,n[4]=d-S,n[5]=1-(h+v),n[6]=_+b,n[7]=0,n[8]=w+P,n[9]=_-b,n[10]=1-(h+m),n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function vt(n,t,e,i){var s=t[0],r=t[1],a=t[2],o=t[3],f=s+s,c=r+r,h=a+a,d=s*f,w=s*c,m=s*h,_=r*c,v=r*h,b=a*h,P=o*f,S=o*c,H=o*h,A=i[0],F=i[1],B=i[2];return n[0]=(1-(_+b))*A,n[1]=(w+H)*A,n[2]=(m-S)*A,n[3]=0,n[4]=(w-H)*F,n[5]=(1-(d+b))*F,n[6]=(v+P)*F,n[7]=0,n[8]=(m+S)*B,n[9]=(v-P)*B,n[10]=(1-(d+_))*B,n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}function Ct(n,t,e,i,s){var r=1/Math.tan(t/2),a;return n[0]=r/e,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=r,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,s!=null&&s!==1/0?(a=1/(i-s),n[10]=(s+i)*a,n[14]=2*s*i*a):(n[10]=-1,n[14]=-2*i),n}var Mt=Ct,V=(n=>(n[n.MOUSE_MOVE=0]="MOUSE_MOVE",n[n.MOUSE_CLICK=1]="MOUSE_CLICK",n[n.KEYBOARD_CLICK=2]="KEYBOARD_CLICK",n))(V||{});class E{static _instance=null;canvas;mousePosition=new u([0,0]);mouseMoment=new u([0,0]);mousePressButton=[];keyPressButton=[];registeredFunction=new Map;constructor(){if(E._instance!=null)return E._instance;let t=L.instance?.canvasDOM;if(t==null)throw new Error("Canvas not found");this.canvas=t,this.canvas.addEventListener("mousemove",this.mouseover.bind(this)),this.canvas.addEventListener("mousedown",this.mousedown.bind(this)),this.canvas.addEventListener("mouseup",this.mouseup.bind(this)),window.addEventListener("keydown",this.keydown.bind(this)),window.addEventListener("keyup",this.keyup.bind(this)),E._instance=this}runEvent(t,e){(this.registeredFunction.get(t)||[]).forEach(s=>s(e))}resetMovement(){this.mouseMoment=new u([0,0])}mouseover(t){let e=t.x-this.canvas.getBoundingClientRect().x,i=t.y-this.canvas.getBoundingClientRect().y;this.mousePosition=new u([e,i]),this.mouseMoment=new u([t.movementX,t.movementY]),this.runEvent(V.MOUSE_MOVE,t)}mousedown(t){this.mousePressButton.push(t.button),this.runEvent(V.MOUSE_CLICK,t)}mouseup(t){this.mousePressButton=this.mousePressButton.filter(e=>e!=t.button),this.runEvent(V.MOUSE_CLICK,t)}keydown(t){this.keyPressButton.some(e=>e===t.key)||this.keyPressButton.push(t.key),this.runEvent(V.KEYBOARD_CLICK,t)}keyup(t){this.keyPressButton=this.keyPressButton.filter(e=>e!=t.key),this.runEvent(V.KEYBOARD_CLICK,t)}registerEvent(t,e){this.registeredFunction.has(t)||this.registeredFunction.set(t,[]);let i=this.registeredFunction.get(t);if(i!=null){let s=i.length;return i.push(e),this.registeredFunction.set(t,i),s}return-1}unRegisterEvent(t,e){let i=this.registeredFunction.get(t);i!=null&&(i=i.filter((s,r)=>r!==e),this.registeredFunction.set(t,i))}getMouseMoment(){return this.mouseMoment}getMousePosition(){return this.mousePosition}getKeyPress(){return this.keyPressButton}isMouseButtonClick(t){return this.mousePressButton.some(e=>e!=t)}isKeyButtonPress(t){return this.keyPressButton.some(e=>e===t)}mouseLock(){this.canvas.requestPointerLock()}mouseUnlock(){document.exitPointerLock()}static get instance(){return this._instance==null&&(this._instance=new E),this._instance}}class p{static _instance;canvasController;_models;isRunning;lastTime;timeScale=1;_mainCamera=null;_mapController=null;constructor(t){p._instance=this,E.instance,this.canvasController=t,this.isRunning=!1,this.lastTime=-1,this._models=[]}start(t){this.isRunning||(this.isRunning=!0,this.lastTime=Date.now(),this.gameLoop(t))}stop(){this.isRunning=!1}addModel(t){this._models.push(t)}gameLoop(t){if(!this.isRunning)return;let e=(Date.now()-this.lastTime)/1e3*this.timeScale;this.lastTime=Date.now();let i=this.canvasController.canvasCtx;i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.clearColor(.5,.5,.5,.9),i.clearDepth(1),i.viewport(0,0,this.canvasController.canvasDOM.width,this.canvasController.canvasDOM.height),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this._mapController!==null&&this._mapController.clear(),this._models.forEach(s=>s.update(e)),t(e),E.instance.resetMovement(),requestAnimationFrame(()=>this.gameLoop(t))}addMapController(t){this._mapController=t}static get instance(){return this._instance}get models(){return this._models}get mapController(){return this._mapController}get mainCamera(){return this._mainCamera}set mainCamera(t){this._mainCamera=t}removeModel(t){this._models=this._models.filter(e=>e!=t)}}class Ot extends k{fov;aspect;near;far;_perspective;constructor({fov:t,aspect:e,near:i,far:s}){super(10),this.fov=t,this.aspect=e||L.instance?.getAspect()||window.innerWidth/window.innerHeight,this.near=i,this.far=s,this._perspective=Z(),this.calcPerspective()}setAsMainCamera(){p.instance.mainCamera=this}getViewMatrix(){let t=this.modelOwner,e=Z();return t&&yt(e,C.setFromEuler(t.rotation).toArray(),t.position.toArray()),e}calcPerspective(){this._perspective=Z(),Mt(this._perspective,this.fov*Math.PI/180,this.aspect,this.near,this.far)}update(t){}get perspective(){return this._perspective}}class x{_r;_g;_b;_a;constructor(t){t instanceof Array?(this._r=t[0],this._g=t[1],this._b=t[2],this._a=t[3]):(this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a)}toString(){return`rgba(${this._r},${this._g},${this._b},${this._a})`}get r(){return this._r}set r(t){this._r=t}get g(){return this._g}set g(t){this._g=t}get b(){return this._b}set b(t){this._b=t}get a(){return this._a}set a(t){this._a=t}static BLACK=new x([0,0,0,1]);static WHITE=new x([255,255,255,1]);static YELLOW=new x([255,255,0,1]);static ORANGE=new x([255,127,80,1]);static randomColor(){let t=Math.floor(Math.random()*256),e=Math.floor(Math.random()*256),i=Math.floor(Math.random()*256);return new x([t,e,i,1])}}class I extends k{static colliders=[];_isCollide=!1;_collisionsObjects=[];_colliderName;whenCollide;constructor(t,e){super(101),I.colliders.push(this),this._colliderName=t,this.whenCollide=e,this._isCollide=!1}update(t){this._isCollide=!1,this._collisionsObjects=[],I.colliders.forEach(e=>{e!=this&&this.checkCollision(e)})}get isCollide(){return this._isCollide}get colliderName(){return this._colliderName}get collisionsObjects(){return this._collisionsObjects}}class mt extends I{_size;constructor({size:t,whenCollide:e}){super("rectXZ",e||(()=>{})),this._size=t}checkCollision(t){switch(t.colliderName){case"circleXZ":this.checkCollisionCircleXZ(t)&&(this._isCollide=!0,this.collisionsObjects.push(t),this.whenCollide());break}}checkCollisionCircleXZ(t){let e=this.modelOwner,i=t.modelOwner;if(e==null||i==null)return!1;let s=new u([e.position.x,e.position.z]).sub(this.size),r=new u([e.position.x,e.position.z]).add(this.size),a={x:i.position.x,y:i.position.z};return a.x<s.x?a.x=s.x:a.x>r.x&&(a.x=r.x),a.y<s.y?a.y=s.y:a.y>r.y&&(a.y=r.y),new u(a).sub(new u([i.position.x,i.position.z])).lengthSq()<=t.radius*t.radius}get size(){let t=new u([this.modelOwner?.scale.x||1,this.modelOwner?.scale.z||1]);return this._size.mul(t)}}class N extends I{_radius;constructor({radius:t,whenCollide:e}){super("circleXZ",e||(()=>{})),this._radius=t}checkCollision(t){switch(t.colliderName){case"circleXZ":this.checkCollisionCircleXZ(t)&&(this._isCollide=!0,this.collisionsObjects.push(t),this.whenCollide());break;case"rectXZ":t.checkCollisionCircleXZ(this)&&(this._isCollide=!0,this.collisionsObjects.push(t),this.whenCollide())}}checkCollisionCircleXZ(t){let e=this.modelOwner,i=t.modelOwner;if(e==null||i==null)return!1;let r=i.position.toVec2XZ().sub(e.position.toVec2XZ()).lengthSq(),a=this.radius+t.radius;return r<a*a}get radius(){return this._radius}}class it extends k{movementSpeed;sensitivity;constructor({movementSpeed:t,sensitivity:e}){super(102),this.movementSpeed=t,this.sensitivity=e,L.instance?.canvasDOM.addEventListener("click",()=>E.instance.mouseLock())}repairPosition(){if(this.modelOwner==null)return;let t=this.modelOwner.modules.filter(e=>e instanceof I&&e.isCollide);if(t.length>0){let e=new u([0,0]);t.forEach(i=>{i instanceof N&&(i.collisionsObjects.forEach(s=>{if(s==i||!(s instanceof mt))return;let r=s,a=r.modelOwner;if(this.modelOwner==null||a==null)return;let o=a.position.toVec2XZ().sub(r.size),f=a.position.toVec2XZ().add(r.size),c=[this.modelOwner.position.x,this.modelOwner.position.z];c[0]=c[0]<o.x?o.x:c[0],c[1]=c[1]<o.y?o.y:c[1],c[0]=c[0]>f.x?f.x:c[0],c[1]=c[1]>f.y?f.y:c[1];let h=new u(c),d=h.sub(this.modelOwner.position.toVec2XZ()).lengthSq(),w;d==0?w=h.sub(a.position.toVec2XZ()).normalize():w=this.modelOwner.position.toVec2XZ().sub(h).normalize();let m=[0,0];w.x!=0?m[0]=(i.radius+r.size.x-Math.abs(this.modelOwner.position.x-a.position.x))*w.x:w.y!=0&&(m[1]=(i.radius+r.size.y-Math.abs(this.modelOwner.position.z-a.position.z))*w.y),e=e.add(new u(m))}),this.modelOwner&&(this.modelOwner.position=this.modelOwner.position.add(new l([e.x,0,e.y]))))})}}update(t){if(this.modelOwner==null)return;let e=[0,0,0];E.instance.isKeyButtonPress("w")&&(e[2]=-1),E.instance.isKeyButtonPress("s")&&(e[2]=1),E.instance.isKeyButtonPress("d")&&(e[0]=1),E.instance.isKeyButtonPress("a")&&(e[0]=-1);let i=C.setFromEuler(this.modelOwner.rotation).mul(new l(e));this.modelOwner.position=this.modelOwner.position.add(i.mul(this.movementSpeed*t));let s=E.instance.getMouseMoment();this.modelOwner.rotation=this.modelOwner.rotation.add(new l([0,-s.x,0]).mul(this.sensitivity*t))}clip(t,e,i){return t<e?e:t>i?i:t}}class z extends k{Pmatrix=null;Vmatrix=null;Mmatrix=null;normalMatrix=null;index_buffer=null;shaderProgram=null;vertex_buffer=null;normal_buffer=null;color_buffer=null;mesh;texture;constructor({mesh:t,texture:e}){super(100),this.mesh=t,this.texture=e,this.texture.calculatingColor(this.mesh.vertices),this.init()}changeTexture(t){let e=L.instance?.canvasCtx;!e||(this.texture=t,this.texture.calculatingColor(this.mesh.vertices),this.color_buffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.color_buffer),e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texture.colorVertices),e.STATIC_DRAW))}init(){let t=L.instance?.canvasCtx;if(!!t){this.vertex_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertex_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.mesh.vertices),t.STATIC_DRAW),this.normal_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.normal_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.mesh.vertices),t.STATIC_DRAW),this.color_buffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.color_buffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.texture.colorVertices),t.STATIC_DRAW),this.index_buffer=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.index_buffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.mesh.triangles),t.STATIC_DRAW);var e="attribute vec3 position;attribute vec3 normal;uniform mat4 Pmatrix;uniform mat4 Vmatrix;uniform mat4 Mmatrix;uniform mat4 uNormalMatrix;attribute vec3 color;varying vec3 vColor;varying vec3 vLighting;void main(void) { gl_Position = Pmatrix*Vmatrix*Mmatrix*vec4(position, 1.);vColor = color;highp vec3 ambientLight = vec3(0.3, 0.3,0.3);highp vec3 directionalLightColor = vec3(1, 0.2, 0.2);highp vec3 directionalVector = normalize(vec3(0, 5, 0));highp vec4 transformedNormal = uNormalMatrix * vec4(normal, 1.0);highp float directional = max(dot(transformedNormal.xyz, directionalVector), 0.0);vLighting = ambientLight + (directionalLightColor * directional);}",i="precision mediump float;varying vec3 vColor;varying highp vec3 vLighting;void main(void) {gl_FragColor = vec4(vColor*vLighting, 1.);}",s=t.createShader(t.VERTEX_SHADER);if(!!s){t.shaderSource(s,e),t.compileShader(s);var r=t.createShader(t.FRAGMENT_SHADER);!r||(t.shaderSource(r,i),t.compileShader(r),this.shaderProgram=t.createProgram(),this.shaderProgram&&(t.attachShader(this.shaderProgram,s),t.attachShader(this.shaderProgram,r),t.linkProgram(this.shaderProgram)))}}}update(t){let e=this.modelOwner;if(!e)return;let i=L.instance;if(!i||!this.shaderProgram)return;let s=i.canvasCtx;const r=Z();vt(r,e.getQuaternionRotation().toArray(),e.position.toArray(),e.scale.toArray());let a=p.instance.mainCamera;if(!a)return;let o=Z();dt(o,a.getViewMatrix());const f=Z();dt(f,r),_t(f,f),this.Pmatrix=s.getUniformLocation(this.shaderProgram,"Pmatrix"),this.Vmatrix=s.getUniformLocation(this.shaderProgram,"Vmatrix"),this.Mmatrix=s.getUniformLocation(this.shaderProgram,"Mmatrix"),this.normalMatrix=s.getUniformLocation(this.shaderProgram,"uNormalMatrix"),s.bindBuffer(s.ARRAY_BUFFER,this.vertex_buffer);var c=s.getAttribLocation(this.shaderProgram,"position");s.vertexAttribPointer(c,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(c),s.bindBuffer(s.ARRAY_BUFFER,this.normal_buffer);var h=s.getAttribLocation(this.shaderProgram,"normal");s.vertexAttribPointer(h,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(h),s.bindBuffer(s.ARRAY_BUFFER,this.color_buffer);var d=s.getAttribLocation(this.shaderProgram,"color");s.vertexAttribPointer(d,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(d),s.useProgram(this.shaderProgram),s.uniformMatrix4fv(this.Pmatrix,!1,a.perspective),s.uniformMatrix4fv(this.Vmatrix,!1,o),s.uniformMatrix4fv(this.Mmatrix,!1,r),s.uniformMatrix4fv(this.normalMatrix,!1,f),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,this.index_buffer),s.drawElements(s.TRIANGLES,this.mesh.triangles.length,s.UNSIGNED_SHORT,0)}}class Et{_vertices;_triangles;_normals;constructor(t){this._vertices=t?.vertices?.reduce((e,i)=>[...e,...i],[])||[],this._triangles=t?.triangles?.reduce((e,i)=>[...e,...i],[])||[],this._normals=t?.normal?.reduce((e,i)=>[...e,...i],[])||[]}get vertices(){return this._vertices}get triangles(){return this._triangles}get normals(){return this._normals}}class bt extends Et{constructor(){super({vertices:[],triangles:[],normal:[]})}addVertex(t){this.vertices.push(...t)}addTriangle(t){this.triangles.push(...t)}addNormal(t){this.normals.push(...t)}}const ot={parse(n){let t=new bt,e=[],i=[];const s={v(o){i.push(o.map(parseFloat))},vn(o){e.push(o.map(parseFloat))},vt(o){},f(o){const f=o.length-2;for(let c=0;c<f;++c){let h=[o[0],o[c+1],o[c+2]].map(w=>{let m=w.split("/");return i[parseInt(m[0])-1]});t.addVertex(h[0]),t.addVertex(h[1]),t.addVertex(h[2]);let d=t.triangles[t.triangles.length-1]||-1;t.addTriangle([d+1,d+2,d+3]),t.addNormal([o[0],o[c+1],o[c+2]].map(w=>{let m=w.split("/");return m[2]==null?[0,0,0]:e[parseInt(m[2])-1]}).reduce((w,m)=>[...w,...m],[]))}}},r=/(\w*)(?: )*(.*)/,a=n.split(`
`);for(let o=0;o<a.length;++o){const f=a[o].trim();if(f===""||f.startsWith("#"))continue;const c=r.exec(f);if(!c)continue;const[,h]=c,d=f.split(/\s+/).slice(1),w=s[h];if(!w){console.warn("unhandled keyword:",h);continue}w(d)}return t}},ht={async load(n){return(await fetch(n)).text()}};let st=ot.parse(await ht.load("resources/models/cube.obj")),Pt=ot.parse(await ht.load("resources/models/ghost.obj")),G=ot.parse(await ht.load("resources/models/ball.obj"));class zt{_colorVertices;constructor(){this._colorVertices=[]}get colorVertices(){return this._colorVertices}}class T extends zt{color;constructor(t){super(),this.color=t}calculatingColor(t){this._colorVertices=[];for(let e=0;e<t.length/3;e++)this._colorVertices.push(this.color.r/255,this.color.g/255,this.color.b/255)}}class Tt extends k{mapController;size;color;constructor({mapController:t,size:e,color:i}){super(),this.mapController=t,this.size=e,this.color=i||x.WHITE}update(t){if(this.modelOwner==null)return;let e=this.modelOwner.position.toVec2XZ(),i=this.size.mul(this.modelOwner.scale.toVec2XZ());this.mapController.drawRect(e,i,this.color)}}class Q extends k{mapController;radius;_color;constructor({mapController:t,radius:e,color:i}){super(),this.mapController=t,this.radius=e,this._color=i||x.WHITE}update(t){if(this.modelOwner==null)return;let e=this.modelOwner.position.toVec2XZ();this.mapController.drawCircle(e,this.radius,this._color)}get color(){return this._color}set color(t){this._color=t}}class D{static _instance=null;score;maxPoints;collectedPoints;static get instance(){return this._instance==null&&(this._instance=new D),this._instance}constructor(){D._instance=this,this.maxPoints=0,this.collectedPoints=0,this.score=-200}increaseMaxPoints(){this.maxPoints++}collectPoint(){this.collectedPoints++,this.collectedPoints>=this.maxPoints&&p.instance.winLevel()}addScore(t){this.score+=t}draw(t){t.drawText("Your score: "+this.score,new u([0,30]),30,x.WHITE)}decreasePoints(){this.maxPoints--}}class X extends R{constructor({position:t,mapController:e}){super({position:t,rotation:l.zero,scale:new l([.5,.5,.5])}),D.instance.increaseMaxPoints();let i=new z({mesh:G,texture:new T(x.YELLOW)});this.addModule(i);let s=new N({radius:1,whenCollide:()=>{let r=this.modules.filter(a=>a instanceof I&&a.isCollide);r.length>0&&r.forEach(a=>{a instanceof N&&a.collisionsObjects.forEach(o=>{if(o!=a&&o.modelOwner!=null&&o.modelOwner.modules.find(f=>f instanceof it)){if(this==null)return;p.instance.removeModel(this),D.instance.collectPoint(),D.instance.addScore(200)}})})}});this.addModule(s),e!=null&&this.addModule(new Q({mapController:e,radius:3,color:x.YELLOW}))}}var g=(n=>(n[n.CHASE=0]="CHASE",n[n.SCATTER=1]="SCATTER",n[n.FRIGHTENED=2]="FRIGHTENED",n))(g||{});let Rt=[[g.SCATTER,30],[g.CHASE,2*60],[g.SCATTER,60],[g.CHASE,560],[g.SCATTER,80],[g.CHASE,10*60],[g.SCATTER,3*60],[g.CHASE,-1]],St=[[g.SCATTER,20],[g.CHASE,3*60],[g.SCATTER,70],[g.CHASE,4*60],[g.SCATTER,60],[g.CHASE,-1]],At=[[g.SCATTER,25],[g.CHASE,4*60],[g.SCATTER,60],[g.CHASE,8*60],[g.SCATTER,20],[g.CHASE,-1]];function Ft(n){return n==1?Rt:n<=4?St:At}class Bt extends R{eyeLeft;eyeRight;color;enable=!0;constructor({position:t,rotation:e,scale:i,color:s,mapController:r,scene:a}){super({position:t,rotation:e,scale:i}),this.color=s,this.generateEye(a);let o=new z({mesh:Pt,texture:new T(s)});this.addModule(o);let f=new N({radius:1,whenCollide:()=>{let c=this.modules.filter(h=>h instanceof I&&h.isCollide);c.length>0&&c.forEach(h=>{h instanceof N&&h.collisionsObjects.forEach(d=>{if(d!=h&&d.modelOwner!=null&&d.modelOwner.modules.find(w=>w instanceof it)){if(this==null)return;M.instance.getState()==g.FRIGHTENED?M.instance.die(this):p.instance.loseLevel()}})})}});this.addModule(f),r!=null&&this.addModule(new Q({mapController:r,radius:5,color:s}))}generateEye(t){this.eyeLeft=new R({position:l.zero,scale:new l([.2,.2,.2])}),this.eyeLeft.addModule(new z({mesh:G,texture:new T(x.BLACK)})),t.addModel(this.eyeLeft),this.eyeRight=new R({position:l.zero,scale:new l([.2,.2,.2])}),this.eyeRight.addModule(new z({mesh:G,texture:new T(x.BLACK)})),t.addModel(this.eyeRight),this.recalcPosition()}get position(){return super.position}set position(t){super.position=t,this.recalcPosition()}recalcPosition(){this.eyeLeft.position=this.position.add(C.setFromEuler(this.rotation).mul(new l([.4,.4,.75]))),this.eyeRight.position=this.position.add(C.setFromEuler(this.rotation).mul(new l([-.4,.4,.75])))}change2Frightened(){let t=this.modules.find(i=>i instanceof z);t!=null&&(t.changeTexture(new T(new x([0,0,255,1]))),t.init());let e=this.modules.find(i=>i instanceof Q);e!=null&&(e.color=new x([0,0,255,1]))}change2NormalForm(){let t=this.modules.find(i=>i instanceof z);t!=null&&(t.changeTexture(new T(this.color)),t.init());let e=this.modules.find(i=>i instanceof Q);e!=null&&(e.color=this.color)}disable(){this.enable=!1}activate(){this.enable=!0}}const Lt=n=>n*Math.PI/180;class Dt{pos;prevPos;steps;constructor(t,e,i){this.pos=t,this.prevPos=e,this.steps=i}}class rt{pathBoard=[];mapBoard=[];nearestElement={distance:1/0,element:null};target=u.zero;getElementPathBoard(t,e){return this.pathBoard[t]==null?null:this.pathBoard[t][e]}setElementPathBoard(t,e,i){this.pathBoard[t]==null&&(this.pathBoard[t]=[]),this.pathBoard[t][e]=i}findPath(t,e,i,s){this.pathBoard=[],this.mapBoard=i,this.target=s,this.stepOfFindingPath(t,e,0);let r=this.nearestElement.element;for(;r!=null&&r.prevPos!=null&&r.steps>1;)r=this.getElementPathBoard(r.prevPos.x,r.prevPos.y);return r?.pos.equal(t)?this.moveAny(t,e):r?.pos}moveAny(t,e){if(console.log("a",this.mapBoard),this.mapBoard[t.x]==null)return;let i=this.mapBoard[t.x][t.y],s=[];return(i&1)==0&&e.x!=t.x-1&&t.x-1>=0&&s.push(t.add(new u([-1,0]))),(i&2)==0&&e.y!=t.y+1&&t.y+1<this.mapBoard[0].length&&s.push(t.add(new u([0,1]))),(i&4)==0&&e.x!=t.x+1&&t.x+1<this.mapBoard.length&&s.push(t.add(new u([1,0]))),(i&8)==0&&e.y!=t.y-1&&t.y-1>=0&&s.push(t.add(new u([0,-1]))),s[Math.floor(Math.random()*s.length)]}stepOfFindingPath(t,e,i){if(this.mapBoard[t.x]==null)return;let s=this.mapBoard[t.x][t.y],r=this.getElementPathBoard(t.x,t.y);if(s==null||r!=null&&r.steps<i)return;this.setElementPathBoard(t.x,t.y,new Dt(t,e,i));let a=this.target.sub(t).lengthSq();a<this.nearestElement.distance&&(this.nearestElement={distance:a,element:this.getElementPathBoard(t.x,t.y)}),(s&1)==0&&e.x!=t.x-1&&this.stepOfFindingPath(t.add(new u([-1,0])),t,i+1),(s&2)==0&&e.y!=t.y+1&&this.stepOfFindingPath(t.add(new u([0,1])),t,i+1),(s&4)==0&&e.x!=t.x+1&&this.stepOfFindingPath(t.add(new u([1,0])),t,i+1),(s&8)==0&&e.y!=t.y-1&&this.stepOfFindingPath(t.add(new u([0,-1])),t,i+1)}}class wt extends k{smallTarget;prevPosition;_target;movementSpeed;chaseCalcFunc;scatterTarget;isFrightened=!1;constructor({movementSpeed:t,chaseCalcFunc:e,scatterTarget:i}){super(),this.movementSpeed=t,this.chaseCalcFunc=e,this.scatterTarget=i,this.smallTarget=null,this.prevPosition=null,this._target=new l([0,0,0])||null}calcTarget(){let t=M.instance.getState();switch(t!=g.FRIGHTENED&&this.isFrightened&&(this.isFrightened=!1,this.modelOwner.change2NormalForm()),t){case g.CHASE:this._target=this.chaseCalcFunc();break;case g.SCATTER:this._target=this.scatterTarget;break;case g.FRIGHTENED:if(!this.isFrightened){this.modelOwner.change2Frightened();let e=this.smallTarget;this.smallTarget=this.prevPosition,this.prevPosition=e}this.isFrightened=!0,this._target=this.scatterTarget;break}}randomWall(){if(this.modelOwner==null||!(p.instance instanceof et))return;let t=p.instance,e=t.getPositionOnBoard(this.modelOwner.position.toVec2XZ()),i=this.prevPosition!=null?t.getPositionOnBoard(this.prevPosition):e,s=new rt;s.mapBoard=t.mapMask;let r=s.moveAny(e,i);console.log(this.modelOwner.position.toVec2XZ(),e,i,r),this.smallTarget=t.getBoardToPosition(r||u.zero)}update(t){if(this.modelOwner==null)return;if(!this.modelOwner.enable){this.smallTarget=null;return}console.log(this.smallTarget),this.calcTarget(),this.smallTarget==null&&(this.isFrightened?this.randomWall():this.findPath(),this.prevPosition=new u([this.modelOwner.position.x,this.modelOwner.position.z]));let e=new l([this.smallTarget?.x||0,this.modelOwner.position.y,this.smallTarget?.y||0]).sub(this.modelOwner.position);if(console.log(e),e.x!=0&&e.z!=0){this.smallTarget=null;return}this.modelOwner.rotation=new l([this.modelOwner.rotation.x,Math.atan2(e.x,e.z),this.modelOwner.rotation.z]),this.modelOwner.position=this.modelOwner.position.add(e.normalize().mul(this.movementSpeed*t)),e.lengthSquare()<.01&&(this.modelOwner.position=new l([this.smallTarget?.x||0,this.modelOwner.position.y,this.smallTarget?.y||0]),this.smallTarget=null)}findPath(){if(this.modelOwner==null||this._target==null||!(p.instance instanceof et))return;let t=p.instance,e=new rt,i=t.getPositionOnBoard(this.modelOwner.position.toVec2XZ()),s=this.prevPosition!=null?t.getPositionOnBoard(this.prevPosition):i,r=t.getPositionOnBoard(this._target.toVec2XZ()),a=e.findPath(i,s,t.mapMask,new u([Math.round(r.x),Math.round(r.y)]));this.smallTarget=t.getBoardToPosition(a||u.zero)}get target(){return this._target}}class It extends k{smallTarget;prevPosition;_target;movementSpeed;whenFinish;constructor({movementSpeed:t,target:e,whenFinish:i}){super(),this.movementSpeed=t,this.whenFinish=i,this._target=e,console.log("TARGET",e),this.smallTarget=null,this.prevPosition=null}update(t){if(this.modelOwner==null)return;this.smallTarget==null&&(this.findPath(),this.prevPosition=new u([this.modelOwner.position.x,this.modelOwner.position.z]));let e=new l([this.smallTarget?.x||0,this.modelOwner.position.y,this.smallTarget?.y||0]).sub(this.modelOwner.position);this.modelOwner.rotation=new l([this.modelOwner.rotation.x,Math.atan2(e.x,e.z),this.modelOwner.rotation.z]),this.modelOwner.position=this.modelOwner.position.add(e.normalize().mul(this.movementSpeed*t)),e.lengthSquare()<.01&&(this.modelOwner.position=new l([this.smallTarget?.x||0,this.modelOwner.position.y,this.smallTarget?.y||0]),this.smallTarget=null),this._target.sub(this.modelOwner.position).lengthSquare()<.01&&this.whenFinish()}findPath(){if(this.modelOwner==null||!(p.instance instanceof et))return;let t=p.instance,e=new rt,i=t.getPositionOnBoard(this.modelOwner.position.toVec2XZ()),s=this.prevPosition!=null?t.getPositionOnBoard(this.prevPosition):i,r=t.getPositionOnBoard(this._target.toVec2XZ()),a=e.findPath(i,s,t.mapMask,new u([Math.round(r.x),Math.round(r.y)]));this.smallTarget=t.getBoardToPosition(a||u.zero)}}class ft extends k{mapController;canRotation;image;isImageLoaded=!1;size;constructor({mapController:t,imageSrc:e,canRotation:i,size:s}){super(),this.size=s,this.mapController=t,this.canRotation=i||!1,this.image=new Image,this.image.src=e,this.image.addEventListener("load",()=>{this.isImageLoaded=!0})}update(t){if(this.modelOwner==null||!this.isImageLoaded)return;let e=this.modelOwner.position.toVec2XZ();this.mapController.drawImage(this.image,e,-(this.canRotation?this.modelOwner.rotation.y+Math.PI:0),this.size)}}class kt extends R{eyeLeft;eyeRight;constructor({position:t,rotation:e,scale:i,ghost:s,target:r,mapController:a,scene:o,movementSpeed:f}){let c=o.getPositionOnBoard(t.toVec2XZ()),h=o.getBoardToPosition(new u([Math.round(c.x),Math.round(c.y)]));console.log(h),super({position:new l([h.x,t.y,h.y]),rotation:e,scale:i}),this.generateEye(o),this.addModule(new It({movementSpeed:f,target:r,whenFinish:()=>{this.deleteEyes(p.instance),p.instance.removeModel(this),M.instance.activateGhost(s)}})),a!=null&&this.addModule(new ft({mapController:a,imageSrc:"eye.png",size:new u([10,5]),canRotation:!0}))}generateEye(t){this.eyeLeft=new R({position:l.zero,scale:new l([.2,.2,.2])}),this.eyeLeft.addModule(new z({mesh:G,texture:new T(x.BLACK)})),t.addModel(this.eyeLeft),this.eyeRight=new R({position:l.zero,scale:new l([.2,.2,.2])}),this.eyeRight.addModule(new z({mesh:G,texture:new T(x.BLACK)})),t.addModel(this.eyeRight),this.recalcPosition()}get position(){return super.position}set position(t){super.position=t,this.recalcPosition()}recalcPosition(){this.eyeLeft.position=this.position.add(C.setFromEuler(this.rotation).mul(new l([.4,.4,.75]))),this.eyeRight.position=this.position.add(C.setFromEuler(this.rotation).mul(new l([-.4,.4,.75])))}deleteEyes(t){t.removeModel(this.eyeLeft),t.removeModel(this.eyeRight)}}let nt=[{color:new x([255,0,0,1]),chaseCalcFunc:()=>p.instance.mainCamera?.modelOwner?.position||l.zero,scatterTarget:new l([-80,0,-80])},{color:new x([255,184,255,1]),chaseCalcFunc:()=>{let n=p.instance.mainCamera?.modelOwner;if(n==null)return l.zero;let t=C.setFromEuler(n.rotation).mul(l.forward),e;return Math.abs(t.x)<Math.abs(t.z)?e=new l([0,0,Math.sign(t.z)]):e=new l([Math.sign(t.x),0,0]),n.position.add(e.mul(-10))},scatterTarget:new l([-80,0,80])},{color:new x([0,255,255,1]),chaseCalcFunc:()=>{let n=M.instance.ghostsModels[0],e=M.instance.ghostsModels[1].modules.find(s=>s instanceof wt).target||l.zero,i=e.sub(n.position);return e.add(i)},scatterTarget:new l([80,0,-80])},{color:new x([255,184,82,1]),chaseCalcFunc:()=>{let n=p.instance.mainCamera?.modelOwner?.position||l.zero;return n.sub(M.instance.ghostsModels[3].position).lengthSquare()<16*16?new l([80,0,80]):n},scatterTarget:new l([80,0,80])}];class M{static _instance=null;spawnPoint;times=[];countGhostExist=0;eatableGhostTimer=0;eatableGhostTime=25;_ghostsModels=[];gameTime;static get instance(){return M._instance==null&&(M._instance=new M),M._instance}constructor(){this.gameTime=0;let e=p.instance.getBoardToPosition(new u([2,5]));this.spawnPoint=new l([e.x,1.8,e.y]),this.loadTimes(p.instance.level)}getState(){if(this.eatableGhostTimer>0)return g.FRIGHTENED;for(let t=0;t<this.times.length;t++)if(this.gameTime<this.times[t][1])return this.times[t][0];return g.CHASE}update(t){if(this.gameTime+=t,this.eatableGhostTimer-=t,!(this.countGhostExist>=nt.length)&&this.gameTime>=this.countGhostExist*this.times[0][1]/nt.length){let e=nt[this.countGhostExist];this.spawnGhost(e.color,e.chaseCalcFunc,e.scatterTarget),this.countGhostExist++}}spawnGhost(t,e,i){let s=p.instance,r=new Bt({position:this.spawnPoint,rotation:new l([0,Lt(-90),0]),scale:new l([1,1,1]),color:t,mapController:s.mapController,scene:s});r.addModule(new wt({movementSpeed:5,chaseCalcFunc:e,scatterTarget:i})),s.addModel(r),this._ghostsModels.push(r)}loadTimes(t){let e=Ft(t),i=[],s=0;for(let r=0;r<e.length;r++)e[r][1]==-1&&(s=1/0),s+=e[r][1],i.push([e[r][0],s]);console.log(i),this.times=i}get ghostsModels(){return this._ghostsModels}activeEatableGhosts(){this.eatableGhostTimer=this.eatableGhostTime}die(t){t.disable();let e=p.instance,i=new kt({position:t.position.copy(),rotation:l.zero,scale:l.one,mapController:e.mapController,ghost:t,target:this.spawnPoint,movementSpeed:10,scene:e});e.addModel(i),t.position=new l([100,100,100])}activateGhost(t){t.position=this.spawnPoint,t.activate()}}class Ht extends R{constructor({position:t,mapController:e}){super({position:t,rotation:l.zero,scale:new l([1,1,1])}),D.instance.increaseMaxPoints();let i=new z({mesh:G,texture:new T(x.ORANGE)});this.addModule(i);let s=new N({radius:2,whenCollide:()=>{let r=this.modules.filter(a=>a instanceof I&&a.isCollide);r.length>0&&r.forEach(a=>{a instanceof N&&a.collisionsObjects.forEach(o=>{if(o!=a&&o.modelOwner!=null&&o.modelOwner.modules.find(f=>f instanceof it)){if(this==null)return;p.instance.removeModel(this),M.instance.activeEatableGhosts()}})})}});this.addModule(s),e!=null&&this.addModule(new Q({mapController:e,radius:5,color:x.ORANGE}))}}let Nt=[[2,4],[2,5],[2,6],[2,7]];class Xt{generatePoints(t,e,i,s,r){let a=[],o=(h,d)=>a[h]==null||a[h][d]==null?!1:a[h][d],f=(h,d,w)=>{a[h]==null&&(a[h]=[]),a[h][d]=w};f(1.5,5,!0),f(1.5,6,!0),t.forEach((h,d)=>{h.forEach((w,m)=>{if(Nt.find(v=>v[0]===d&&v[1]===m))return;let _=new l([(d-t.length/2+.5)*e*2,2,(m-t[0].length/2+.5)*e*2]);i.addModel(new X({position:_,mapController:s})),(w&1)==0&&!o(d-.5,m)&&d-.5>0&&(i.addModel(new X({position:_.add(new l([-e,0,0])),mapController:s})),f(d-.5,m,!0)),(w&2)==0&&!o(d,m+.5)&&m+.5<t[0].length-1&&(i.addModel(new X({position:_.add(new l([0,0,e])),mapController:s})),f(d,m+.5,!0)),(w&4)==0&&!o(d+.5,m)&&d+.5<t.length-1&&(i.addModel(new X({position:_.add(new l([e,0,0])),mapController:s})),f(d+.5,m,!0)),(w&8)==0&&!o(d,m-.5)&&m-.5>0&&(i.addModel(new X({position:_.add(new l([0,0,-e])),mapController:s})),f(d,m-.5,!0))})});let c=[];for(let h=0;h<r;h++){let d=i.models[Math.floor(Math.random()*i.models.length)];if(!(d instanceof X)||c.find(_=>d.position.sub(_.position).lengthSquare()<90)!=null){h--;continue}let w=d.position;i.removeModel(d),D.instance.decreasePoints();let m=new Ht({position:w,mapController:i.mapController});c.push(m),i.addModel(m)}for(let h=0;h<c.length;h++)for(let d=h+1;d<c.length;d++)console.log(h,d,c[h].position.sub(c[d].position).lengthSquare())}}class et extends p{tileSize;wallHeight;wallColor;floorColor;_level=1;_mapMask;constructor({canvasController:t,mapController:e,mapMask:i,tileSize:s,wallHeight:r,wallColor:a,floorColor:o}){super(t),this.addMapController(e),this.tileSize=s||1,this.wallHeight=r||1,this.wallColor=a,this.floorColor=o,this._mapMask=i,this.generateMap(i)}get mapMask(){return this._mapMask}get level(){return this._level}createWall(t,e,i){let s=new R({position:t,rotation:l.zero,scale:i});s.addModule(new z({mesh:st,texture:new T(e)})),this.mapController!=null&&s.addModule(new Tt({mapController:this.mapController,size:u.one})),s.addModule(new mt({size:u.one})),this.addModel(s)}generateMap(t){let e=new R({position:l.zero,rotation:l.zero,scale:new l([this.tileSize*t.length,.5,this.tileSize*t[0].length])});e.addModule(new z({mesh:st,texture:new T(this.floorColor)})),this.addModel(e);let i=new R({position:l.zero.add(new l([0,this.wallHeight*2,0])),rotation:l.zero,scale:new l([this.tileSize*t.length,.5,this.tileSize*t[0].length])});i.addModule(new z({mesh:st,texture:new T(this.floorColor)})),this.addModel(i),[[1,0],[-1,0],[0,1],[0,-1]].forEach(c=>{this.createWall(new l([this.tileSize*t.length*c[0],.5+this.wallHeight/2,this.tileSize*t[0].length*c[1]]),this.wallColor,new l([c[0]==0?this.tileSize*t.length:.5,this.wallHeight,c[1]==0?this.tileSize*t[0].length:.5]))});let r=[],a=(c,h)=>r[c]==null||r[c][h]==null?!1:r[c][h],o=(c,h,d)=>{r[c]==null&&(r[c]=[]),r[c][h]=d};t.forEach((c,h)=>{c.forEach((d,w)=>{let m=new l([(h-t.length/2+.5)*this.tileSize*2,1.5,(w-t[0].length/2+.5)*this.tileSize*2]);(d&1)>0&&!a(h-.5,w)&&(this.createWall(new l([m.x-this.tileSize,m.y,m.z]),this.wallColor,new l([.5,this.wallHeight,this.tileSize+.5])),o(h-.5,w,!0)),(d&2)>0&&!a(h,w+.5)&&(this.createWall(new l([m.x,m.y,m.z+this.tileSize]),this.wallColor,new l([this.tileSize+.5,this.wallHeight,.5])),o(h,w+.5,!0)),(d&4)>0&&!a(h+.5,w)&&(this.createWall(new l([m.x+this.tileSize,m.y,m.z]),this.wallColor,new l([.5,this.wallHeight,this.tileSize+.5])),o(h+.5,w,!0)),(d&8)>0&&!a(h,w-.5)&&(this.createWall(new l([m.x,m.y,m.z-this.tileSize]),this.wallColor,new l([this.tileSize+.5,this.wallHeight,.5])),o(h,w-.5,!0))})}),new Xt().generatePoints(t,this.tileSize,this,this.mapController,6)}getPositionOnBoard(t){let e=t.x/(this.tileSize*2)+this._mapMask.length/2-.5,i=t.y/(this.tileSize*2)+this._mapMask[0].length/2-.5;return new u([e,i])}getBoardToPosition(t){let e=(t.x-this.mapMask.length/2+.5)*this.tileSize*2,i=(t.y-this.mapMask[0].length/2+.5)*this.tileSize*2;return new u([e,i])}winLevel(){alert("WIN")}loseLevel(){alert("LOSE")}}class Vt{canvasDOM;canvasCtx;width;height;translateMap;scale;isRotate90;constructor({elementName:t,translateMap:e,scale:i,isRotate90:s}){let r=document.querySelector(t);if(r==null)throw new Error("Element must exist");this.canvasDOM=r,this.width=this.canvasDOM.width,this.height=this.canvasDOM.height;let a=this.canvasDOM.getContext("2d");if(a==null)throw new Error("Element must exist");this.canvasCtx=a,this.translateMap=e,this.scale=i,this.isRotate90=s}clear(){this.canvasCtx.clearRect(0,0,this.width,this.height)}drawRect(t,e,i){let s=t.sub(e).mul(this.scale).add(this.translateMap).add(new u([this.width/2,this.height/2])),r=e.mul(2).mul(this.scale);this.canvasCtx.fillStyle=i.toString(),this.isRotate90?this.canvasCtx.fillRect(s.y,s.x,r.y,r.x):this.canvasCtx.fillRect(s.x,s.y,r.x,r.y)}drawCircle(t,e,i){let s=t.mul(this.scale).add(this.translateMap).add(new u([this.width/2,this.height/2]));this.canvasCtx.fillStyle=i.toString(),this.isRotate90&&(s=new u([s.y,s.x])),this.canvasCtx.beginPath(),this.canvasCtx.fillStyle=i.toString(),this.canvasCtx.arc(s.x,s.y,e,0,2*Math.PI),this.canvasCtx.fill()}drawImage(t,e,i,s){let r=e.mul(this.scale).add(this.translateMap).add(new u([this.width/2,this.height/2]));this.isRotate90&&(r=new u([r.y,r.x])),this.canvasCtx.save(),this.canvasCtx.translate(r.x,r.y),this.canvasCtx.rotate(-i),this.canvasCtx.drawImage(t,-s.x/2,-s.y/2,s.x,s.y),this.canvasCtx.restore()}drawText(t,e,i,s){let r=e.mul(this.scale).add(this.translateMap);this.isRotate90&&(r=new u([r.y,r.x])),this.canvasCtx.fillStyle=s.toString(),this.canvasCtx.font=`${i}px`,this.canvasCtx.fillText(t,r.x,r.y)}}class Zt{canvasDOM;canvasCtx;width;height;constructor({elementName:t}){let e=document.querySelector(t);if(e==null)throw new Error("Element must exist");this.canvasDOM=e,this.width=this.canvasDOM.width,this.height=this.canvasDOM.height;let i=this.canvasDOM.getContext("2d");if(i==null)throw new Error("Element must exist");this.canvasCtx=i}clear(){this.canvasCtx.clearRect(0,0,this.width,this.height)}drawRect(t,e,i){let s=t.sub(e);this.canvasCtx.fillStyle=i.toString(),this.canvasCtx.fillRect(s.y,s.x,e.y,e.x)}drawCircle(t,e,i){this.canvasCtx.fillStyle=i.toString(),this.canvasCtx.beginPath(),this.canvasCtx.fillStyle=i.toString(),this.canvasCtx.arc(t.x,t.y,e,0,2*Math.PI),this.canvasCtx.fill()}drawImage(t,e,i,s){this.canvasCtx.save(),this.canvasCtx.translate(e.x,e.y),this.canvasCtx.rotate(-i),this.canvasCtx.drawImage(t,-s.x/2,-s.y/2,s.x,s.y),this.canvasCtx.restore()}drawText(t,e,i,s){this.canvasCtx.fillStyle=s.toString(),this.canvasCtx.font=`${i}px sans-serif`,this.canvasCtx.fillText(t,e.x,e.y)}}let Gt=new L("#mainCanvas"),gt=new Vt({elementName:"#mapCanvas",translateMap:new u([-220,300]),scale:new u([5,5]),isRotate90:!0}),ut=new Zt({elementName:"#infoCanvas"}),Ut=[[0,4,2,8,4,4,4,4,2,8,4,0],[2,9,4,0,5,1,1,5,0,4,3,8],[0,0,5,2,13,4,4,7,8,5,0,0],[2,12,1,0,5,5,5,5,0,1,6,8],[0,1,2,8,1,1,1,1,2,8,1,0]],U=new et({canvasController:Gt,mapController:gt,mapMask:Ut,tileSize:3,wallHeight:2,wallColor:x.randomColor(),floorColor:x.randomColor()});U.createWall(new l([-3,.5+1,3]),x.randomColor(),new l([.25,2,3]));U.createWall(new l([-3,.5+1,-3]),x.randomColor(),new l([.25,2,3]));let tt=new R({position:new l([6,2,0]),rotation:new l([0,0,0])}),xt=new Ot({fov:60,near:.01,far:1e3}),at=new it({movementSpeed:5,sensitivity:5}),qt=new ft({mapController:gt,imageSrc:"pacman.png",size:new u([10,10]),canRotation:!0}),Wt=new N({radius:1,whenCollide:at.repairPosition.bind(at)});tt.addModule(xt);tt.addModule(at);tt.addModule(Wt);tt.addModule(qt);U.addModel(tt);xt.setAsMainCamera();M.instance;let pt=n=>{ut.clear(),M.instance.update(n),D.instance.draw(ut)};U.start(pt);window.addEventListener("focus",()=>U.start(pt));window.addEventListener("blur",()=>U.stop());
